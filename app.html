<!DOCTYPE html>
<html lang="en">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1.0">
  <title>Mythras Classic Fantasy Character Sheet</title>
  <script>
    // Auth check - redirect to login if not authenticated
    (function() {
      const SESSION_HOURS = 24;
      const authData = localStorage.getItem('mythras_auth');
      if (!authData) {
        window.location.href = 'index.html';
        return;
      }
      try {
        const { timestamp } = JSON.parse(authData);
        const hoursSinceLogin = (Date.now() - timestamp) / (1000 * 60 * 60);
        if (hoursSinceLogin >= SESSION_HOURS) {
          localStorage.removeItem('mythras_auth');
          window.location.href = 'index.html';
        }
      } catch (e) {
        localStorage.removeItem('mythras_auth');
        window.location.href = 'index.html';
      }
    })();
  </script>
  <link rel="stylesheet" href="css/main.css">
  <link rel="stylesheet" href="css/theme.css">
  <link rel="stylesheet" href="css/theme-dark.css">
  <link rel="stylesheet" href="css/print.css" media="print">
  <!-- Font Awesome Pro (sharp-duotone requires Pro subscription) -->
  <link rel="stylesheet" href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.5.1/css/all.min.css">
  <link rel="preconnect" href="https://fonts.googleapis.com">
  <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin>
  <link href="https://fonts.googleapis.com/css2?family=Cinzel:wght@400;600;700&family=Crimson+Text:ital,wght@0,400;0,600;1,400&display=swap" rel="stylesheet">
</head>
<body>
  <div id="app" class="character-sheet" data-sheet-type="human">
    
    <!-- Navigation Tabs -->
    <nav class="sheet-navigation no-print">
      <ul class="tab-list">
        <li><button class="tab-btn" data-page="portrait">Portrait</button></li>
        <li><button class="tab-btn active" data-page="main">Character</button></li>
        <li><button class="tab-btn" data-page="combat">Combat / Abilities</button></li>
        <li><button class="tab-btn" data-page="magic1">Cantrips-Rank 2 Spells</button></li>
        <li><button class="tab-btn" data-page="magic2">Ranks 3-5 Spells</button></li>
        <li><button class="tab-btn" data-page="summary">Summary</button></li>
        <li><button class="tab-btn" data-page="notes">Notes</button></li>
      </ul>
      <div class="sheet-controls">
        <button id="btn-class-theme" class="btn btn-secondary" title="Use Class Display">üé≠ Class Theme</button>
        <button id="btn-theme" class="btn btn-secondary" title="Toggle Dark Mode">üåô</button>
        <select id="sheet-type-select" class="sheet-type-selector">
          <option value="human">Human / Demihuman</option>
          <option value="syrin">Syrin</option>
        </select>
        <button id="btn-save" class="btn btn-primary">Save</button>
        <button id="btn-load" class="btn btn-secondary">Load</button>
        <button id="btn-export" class="btn btn-secondary">Export JSON</button>
        <button id="btn-print" class="btn btn-secondary">Print</button>
        <button id="btn-logout" class="btn btn-secondary">Logout</button>
      </div>
    </nav>

    <!-- ==================== PAGE 1: PORTRAIT ==================== -->
    <section id="page-portrait" class="sheet-page page-portrait">
      <div class="portrait-frame ornate-border">
        <div class="portrait-container full-body-portrait">
          <input type="file" id="full-body-upload" accept="image/*" class="image-upload-input">
          <label for="full-body-upload" class="image-upload-label">
            <span class="upload-text">Click Here</span>
            <span class="upload-subtext">to add a full body image of your character.</span>
          </label>
          <img id="full-body-image" class="portrait-image hidden" alt="Character full body portrait">
          <button class="btn-remove-image hidden" data-target="full-body">√ó</button>
        </div>
      </div>
    </section>

    <!-- ==================== PAGE 2: MAIN CHARACTER SHEET ==================== -->
    <section id="page-main" class="sheet-page page-main active">
      <div class="page-content ornate-border">
        
        <!-- Header Row -->
        <header class="sheet-header">
          <div class="header-left">
            <div class="field-row">
              <label class="field-label field-label-large">Character</label>
              <input type="text" id="character-name" class="field-input field-input-large" placeholder="">
            </div>
            <div class="field-row">
              <label class="field-label">Species/Culture</label>
              <input type="text" id="species" class="field-input field-input-half" placeholder="">
              <span class="field-separator">/</span>
              <input type="text" id="culture" class="field-input field-input-half" placeholder="">
            </div>
            <div class="field-row">
              <label class="field-label">Class</label>
              <input type="text" id="class-primary" class="field-input field-input-third" placeholder="">
              <span class="field-separator">/</span>
              <input type="text" id="class-secondary" class="field-input field-input-third" placeholder="">
              <span class="field-separator">/</span>
              <input type="text" id="class-tertiary" class="field-input field-input-third" placeholder="">
            </div>
            <div class="field-row">
              <label class="field-label">Rank Name</label>
              <input type="text" id="rank-name" class="field-input" placeholder="">
            </div>
            <div class="field-row">
              <label class="field-label">Gender</label>
              <input type="text" id="gender" class="field-input" placeholder="">
            </div>
            <div class="field-row field-row-with-rest">
              <label class="field-label">Age</label>
              <input type="number" id="age" class="field-input field-input-small" placeholder="">
              <label class="field-label">Handedness</label>
              <input type="text" id="handedness" class="field-input field-input-small" placeholder="">
              <div class="rest-buttons">
                <button class="rest-btn rest-btn-short" id="btn-short-rest" title="Short Rest: Recover one Fatigue level (15 min ‚Äì 12 hrs depending on state)">
                  <span class="rest-icon">‚òÄ</span>
                  <span class="rest-text">Short Rest</span>
                </button>
                <button class="rest-btn rest-btn-long" id="btn-long-rest" title="Long Rest: Fully recover to Fresh">
                  <span class="rest-icon">‚õ∫</span>
                  <span class="rest-text">Long Rest</span>
                </button>
              </div>
            </div>
          </div>
          
          <div class="header-center">
            <div class="field-row">
              <label class="field-label">Height</label>
              <input type="text" id="height" class="field-input field-input-small" placeholder="5' 10&quot;">
            </div>
            <div class="field-row">
              <label class="field-label">Weight</label>
              <input type="number" id="weight" class="field-input field-input-small" placeholder="">
              <span class="field-suffix">Lb.</span>
            </div>
            <div class="field-row">
              <label class="field-label">Hair</label>
              <input type="text" id="hair" class="field-input" placeholder="">
            </div>
            <div class="field-row">
              <label class="field-label">Eyes</label>
              <input type="text" id="eyes" class="field-input" placeholder="">
            </div>
            <div class="field-row">
              <label class="field-label">Deity/ies</label>
              <input type="text" id="deity-name" class="field-input" placeholder="">
            </div>
            <div class="prereq-skills">
              <div class="prereq-row">
                <svg class="prereq-key" viewBox="0 0 32 32">
                  <defs>
                    <linearGradient id="gold-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#F5D98A"/>
                      <stop offset="50%" style="stop-color:#D4A84B"/>
                      <stop offset="100%" style="stop-color:#B8860B"/>
                    </linearGradient>
                  </defs>
                  <path d="M20 4a8 8 0 00-7.2 11.5L4 24.3V28h3.7l8.8-8.8A8 8 0 1020 4zm0 12a4 4 0 110-8 4 4 0 010 8z" fill="url(#gold-grad)" stroke="#8B6914" stroke-width="1"/>
                  <rect x="17" y="6" width="6" height="6" rx="1" transform="rotate(45 20 9)" fill="none" stroke="#8B6914" stroke-width="1.5"/>
                </svg>
                <span class="prereq-label clickable" id="prereq-label-primary" data-class-slot="primary">Class Prereq. Skill</span>
              </div>
              <div class="prereq-row">
                <svg class="prereq-key" viewBox="0 0 32 32">
                  <defs>
                    <linearGradient id="silver-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#E8E8E8"/>
                      <stop offset="50%" style="stop-color:#B8B8B8"/>
                      <stop offset="100%" style="stop-color:#888888"/>
                    </linearGradient>
                  </defs>
                  <path d="M20 4a8 8 0 00-7.2 11.5L4 24.3V28h3.7l8.8-8.8A8 8 0 1020 4zm0 12a4 4 0 110-8 4 4 0 010 8z" fill="url(#silver-grad)" stroke="#666666" stroke-width="1"/>
                  <rect x="17" y="6" width="6" height="6" rx="1" transform="rotate(45 20 9)" fill="none" stroke="#666666" stroke-width="1.5"/>
                </svg>
                <span class="prereq-label clickable" id="prereq-label-secondary" data-class-slot="secondary">Subclass 1 Prereq. Skill</span>
              </div>
              <div class="prereq-row">
                <svg class="prereq-key" viewBox="0 0 32 32">
                  <defs>
                    <linearGradient id="blue-grad" x1="0%" y1="0%" x2="100%" y2="100%">
                      <stop offset="0%" style="stop-color:#6A9FD4"/>
                      <stop offset="50%" style="stop-color:#3A6EA5"/>
                      <stop offset="100%" style="stop-color:#1E4D78"/>
                    </linearGradient>
                  </defs>
                  <path d="M20 4a8 8 0 00-7.2 11.5L4 24.3V28h3.7l8.8-8.8A8 8 0 1020 4zm0 12a4 4 0 110-8 4 4 0 010 8z" fill="url(#blue-grad)" stroke="#1A3A5C" stroke-width="1"/>
                  <rect x="17" y="6" width="6" height="6" rx="1" transform="rotate(45 20 9)" fill="none" stroke="#1A3A5C" stroke-width="1.5"/>
                </svg>
                <span class="prereq-label clickable" id="prereq-label-tertiary" data-class-slot="tertiary">Subclass 2 Prereq. Skill</span>
              </div>
            </div>
          </div>
          
          <div class="header-right">
            <div class="rank-and-game-row">
              <div class="rank-section">
                <div class="rank-fields">
                  <h3 class="section-header">Rank(s)</h3>
                  <div class="rank-row">
                    <label class="field-label">Primary Class</label>
                    <input type="number" id="rank-primary" class="field-input field-input-tiny" min="0" max="5" placeholder="">
                  </div>
                  <div class="rank-row">
                    <label class="field-label">2nd</label>
                    <input type="number" id="rank-secondary" class="field-input field-input-tiny" min="0" max="5" placeholder="">
                    <label class="field-label">3rd</label>
                    <input type="number" id="rank-tertiary" class="field-input field-input-tiny" min="0" max="5" placeholder="">
                  </div>
                  <div class="rank-row combined-rank-row">
                    <label class="field-label">Combined Rank</label>
                    <input type="number" id="rank-combined" class="field-input field-input-tiny derived-readonly" readonly>
                  </div>
                </div>
              </div>
              <div class="game-buttons-vertical">
                <button class="game-btn game-btn-new game-btn-small" id="btn-new-game" title="Start a new game session - restore Luck Points">
                  <span class="game-icon">üé≤</span>
                  <span class="game-text">New Game</span>
                </button>
                <button class="game-btn game-btn-finish game-btn-small" id="btn-finish-game" title="Finish game session - add EXP Rolls">
                  <span class="game-icon">üèÜ</span>
                  <span class="game-text">Finish Game</span>
                </button>
              </div>
            </div>
            <div class="tenacity-section">
              <label class="field-label"><button type="button" class="attr-info-btn" data-attr="tenacity">‚Ñπ</button>Tenacity Points</label>
              <input type="number" id="tenacity-max" class="field-input field-input-tiny derived-readonly" readonly>
              <span class="field-separator">/</span>
              <input type="number" id="tenacity-current" class="field-input field-input-tiny" placeholder="">
            </div>
            <div class="exp-rolls-section">
              <label class="field-label">EXP Rolls</label>
              <input type="number" id="exp-rolls" class="field-input field-input-small" placeholder="">
              <button type="button" id="btn-spend-exp" class="btn btn-spend-exp">Spend EXP Rolls</button>
            </div>
          </div>
          
          <div class="header-logo">
            <div class="logo-mythras">
              <span class="logo-text">Mythras</span>
              <span class="logo-subtext">Classic Fantasy</span>
            </div>
            <div class="portrait-thumbnail">
              <input type="file" id="portrait-upload" accept="image/*" class="image-upload-input">
              <label for="portrait-upload" class="image-upload-label thumbnail-label">
                <span class="upload-text-small">Click Here</span>
                <span class="upload-subtext-small">to add a portrait</span>
              </label>
              <img id="portrait-image" class="portrait-image-thumb hidden" alt="Character portrait">
              <button class="btn-remove-image hidden" data-target="portrait">√ó</button>
            </div>
          </div>
        </header>

        <!-- Main Content Grid -->
        <div class="main-content-grid">
          
          <!-- Left Column: Attributes & Skills -->
          <div class="column-left">
            
            <!-- Attributes Row - Two boxes side by side -->
            <div class="attributes-row">
              <!-- Core Attributes Box -->
              <section class="attributes-section core-attributes">
                <h3 class="section-header">Chars.</h3>
                <div class="attribute-row">
                  <label class="attribute-label">STR</label>
                  <input type="number" id="str-value" class="attribute-input char-readonly" data-attr="STR" placeholder="" readonly>
                </div>
                <div class="attribute-row">
                  <label class="attribute-label">CON</label>
                  <input type="number" id="con-value" class="attribute-input char-readonly" data-attr="CON" placeholder="" readonly>
                </div>
                <div class="attribute-row">
                  <label class="attribute-label">SIZ</label>
                  <input type="number" id="siz-value" class="attribute-input char-readonly" data-attr="SIZ" placeholder="" readonly>
                </div>
                <div class="attribute-row">
                  <label class="attribute-label">DEX</label>
                  <input type="number" id="dex-value" class="attribute-input char-readonly" data-attr="DEX" placeholder="" readonly>
                </div>
                <div class="attribute-row">
                  <label class="attribute-label">INT</label>
                  <input type="number" id="int-value" class="attribute-input char-readonly" data-attr="INT" placeholder="" readonly>
                </div>
                <div class="attribute-row">
                  <label class="attribute-label">POW</label>
                  <input type="number" id="pow-value" class="attribute-input char-readonly" data-attr="POW" placeholder="" readonly>
                </div>
                <div class="attribute-row">
                  <label class="attribute-label">CHA</label>
                  <input type="number" id="cha-value" class="attribute-input char-readonly" data-attr="CHA" placeholder="" readonly>
                </div>
              </section>
              
              <!-- Derived Attributes Box -->
              <section class="attributes-section derived-attributes">
                <h3 class="section-header">Attributes</h3>
                <div class="derived-header">
                  <span></span>
                  <span class="derived-header-orig">Orig</span>
                  <span class="derived-header-curr">Curr</span>
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="action-points">‚Ñπ</button>Action Points</span>
                  <input type="number" id="action-points-original" class="derived-input derived-readonly" readonly>
                  <input type="number" id="action-points-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="damage-mod">‚Ñπ</button>Damage Mod</span>
                  <input type="text" id="damage-mod-original" class="derived-input derived-readonly" readonly>
                  <input type="text" id="damage-mod-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original wp-damage-row" id="wp-damage-row" style="display: none;">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="precision-dmg">‚Ñπ</button>Precision Dmg Mod</span>
                  <input type="text" id="wp-damage-mod-original" class="derived-input derived-readonly" readonly>
                  <input type="text" id="wp-damage-mod-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original wp-damage-row" id="gs-damage-row" style="display: none;">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="graceful-dmg">‚Ñπ</button>Graceful Dmg Mod</span>
                  <input type="text" id="gs-damage-mod-original" class="derived-input derived-readonly" readonly>
                  <input type="text" id="gs-damage-mod-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="exp-mod">‚Ñπ</button>Exp Mod</span>
                  <input type="number" id="exp-mod-original" class="derived-input derived-readonly" readonly>
                  <input type="number" id="exp-mod-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="healing-rate">‚Ñπ</button>Healing Rate</span>
                  <input type="number" id="healing-rate-original" class="derived-input derived-readonly" readonly>
                  <input type="number" id="healing-rate-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="initiative">‚Ñπ</button>Initiative <button type="button" class="btn-init-roll" id="btn-init-roll" title="Roll d10 for Initiative"><img src="images/d10-init.svg" alt="d10" class="d10-init-icon"></button></span>
                  <input type="number" id="initiative-original" class="derived-input derived-readonly" readonly>
                  <input type="number" id="initiative-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="luck-points">‚Ñπ</button>Luck Points</span>
                  <input type="number" id="luck-original" class="derived-input derived-readonly" readonly>
                  <input type="number" id="luck-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="magic-points">‚Ñπ</button>Magic Points</span>
                  <input type="number" id="magic-points-original" class="derived-input derived-readonly" readonly>
                  <input type="number" id="magic-points-current" class="derived-input" placeholder="">
                </div>
                <div class="derived-row has-original">
                  <span class="derived-label"><button type="button" class="attr-info-btn" data-attr="movement-rate">‚Ñπ</button>Movement Rate (ft)</span>
                  <input type="number" id="movement-original" class="derived-input derived-readonly" readonly>
                  <input type="number" id="movement-current" class="derived-input" placeholder="">
                </div>
              </section>
            </div>
            
            <!-- Unlock Button spanning both sections -->
            <div class="unlock-button-row">
              <button type="button" id="unlock-originals-btn" class="btn btn-unlock">
                üîí Unlock Characteristics
              </button>
            </div>

            <!-- Standard Skills Section -->
            <section class="skills-section standard-skills">
              <h3 class="section-header">Standard Skills</h3>
              <div class="skills-header">
                <span></span>
                <span></span>
                <span></span>
                <span class="header-base">Base %</span>
                <span class="header-current">%</span>
                <span></span>
              </div>
              
              <div class="skill-row" data-skill="athletics">
                <span class="prereq-keys" data-skill-name="Athletics"></span>
                <span class="skill-name">Athletics</span>
                <span class="skill-formula">STR+DEX</span>
                <span class="skill-base" id="athletics-base">0</span>
                <input type="number" id="athletics-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="boating">
                <span class="prereq-keys" data-skill-name="Boating"></span>
                <span class="skill-name">Boating</span>
                <span class="skill-formula">STR+CON</span>
                <span class="skill-base" id="boating-base">0</span>
                <input type="number" id="boating-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="brawn">
                <span class="prereq-keys" data-skill-name="Brawn"></span>
                <span class="skill-name">Brawn</span>
                <span class="skill-formula">STR+SIZ</span>
                <span class="skill-base" id="brawn-base">0</span>
                <input type="number" id="brawn-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="conceal">
                <span class="prereq-keys" data-skill-name="Conceal"></span>
                <span class="skill-name">Conceal</span>
                <span class="skill-formula">DEX+POW</span>
                <span class="skill-base" id="conceal-base">0</span>
                <input type="number" id="conceal-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="customs">
                <span class="prereq-keys" data-skill-name="Customs"></span>
                <span class="skill-name">Customs</span>
                <span class="skill-formula">INT x2+40</span>
                <span class="skill-base" id="customs-base">0</span>
                <input type="number" id="customs-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="dance">
                <span class="prereq-keys" data-skill-name="Dance"></span>
                <span class="skill-name">Dance</span>
                <span class="skill-formula">DEX+CHA</span>
                <span class="skill-base" id="dance-base">0</span>
                <input type="number" id="dance-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="deceit">
                <span class="prereq-keys" data-skill-name="Deceit"></span>
                <span class="skill-name">Deceit</span>
                <span class="skill-formula">INT+CHA</span>
                <span class="skill-base" id="deceit-base">0</span>
                <input type="number" id="deceit-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="drive">
                <span class="prereq-keys" data-skill-name="Drive"></span>
                <span class="skill-name">Drive</span>
                <span class="skill-formula">DEX+POW</span>
                <span class="skill-base" id="drive-base">0</span>
                <input type="number" id="drive-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="endurance">
                <span class="prereq-keys" data-skill-name="Endurance"></span>
                <span class="skill-name">Endurance</span>
                <span class="skill-formula">CON x2</span>
                <span class="skill-base" id="endurance-base">0</span>
                <input type="number" id="endurance-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="evade">
                <span class="prereq-keys" data-skill-name="Evade"></span>
                <span class="skill-name">Evade</span>
                <span class="skill-formula">DEX x2</span>
                <span class="skill-base" id="evade-base">0</span>
                <input type="number" id="evade-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="first-aid">
                <span class="prereq-keys" data-skill-name="First Aid"></span>
                <span class="skill-name">First Aid</span>
                <span class="skill-formula">INT+DEX</span>
                <span class="skill-base" id="first-aid-base">0</span>
                <input type="number" id="first-aid-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="influence">
                <span class="prereq-keys" data-skill-name="Influence"></span>
                <span class="skill-name">Influence</span>
                <span class="skill-formula">CHA x2</span>
                <span class="skill-base" id="influence-base">0</span>
                <input type="number" id="influence-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="insight">
                <span class="prereq-keys" data-skill-name="Insight"></span>
                <span class="skill-name">Insight</span>
                <span class="skill-formula">INT+POW</span>
                <span class="skill-base" id="insight-base">0</span>
                <input type="number" id="insight-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="locale">
                <span class="prereq-keys" data-skill-name="Locale"></span>
                <span class="skill-name">Locale</span>
                <span class="skill-formula">INT x2</span>
                <span class="skill-base" id="locale-base">0</span>
                <input type="number" id="locale-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="perception">
                <span class="prereq-keys" data-skill-name="Perception"></span>
                <span class="skill-name">Perception</span>
                <span class="skill-formula">INT+POW</span>
                <span class="skill-base" id="perception-base">0</span>
                <input type="number" id="perception-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="ride">
                <span class="prereq-keys" data-skill-name="Ride"></span>
                <span class="skill-name">Ride</span>
                <span class="skill-formula">DEX+POW</span>
                <span class="skill-base" id="ride-base">0</span>
                <input type="number" id="ride-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="sing">
                <span class="prereq-keys" data-skill-name="Sing"></span>
                <span class="skill-name">Sing</span>
                <span class="skill-formula">CHA+POW</span>
                <span class="skill-base" id="sing-base">0</span>
                <input type="number" id="sing-current" class="skill-input" placeholder="">
              </div>
              
              <div class="skill-row" data-skill="stealth">
                <span class="prereq-keys" data-skill-name="Stealth"></span>
                <span class="skill-name">Stealth</span>
                <span class="skill-formula">DEX+INT</span>
                <span class="skill-base" id="stealth-base">0</span>
                <input type="number" id="stealth-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="swim">
                <span class="prereq-keys" data-skill-name="Swim"></span>
                <span class="skill-name">Swim</span>
                <span class="skill-formula">STR+CON</span>
                <span class="skill-base" id="swim-base">0</span>
                <input type="number" id="swim-current" class="skill-input" placeholder="">
                <span class="enc-indicator" title="Affected by ENC"></span>
              </div>
              
              <div class="skill-row" data-skill="willpower">
                <span class="prereq-keys" data-skill-name="Willpower"></span>
                <span class="skill-name">Willpower</span>
                <span class="skill-formula">POW x2</span>
                <span class="skill-base" id="willpower-base">0</span>
                <input type="number" id="willpower-current" class="skill-input" placeholder="">
              </div>
            </section>

            <!-- ENC Penalty Note -->
            <div class="enc-penalty-note">
              <span class="enc-indicator"></span>
              <span>= ENC Penalty</span>
            </div>

            <!-- Skill Grade Reference -->
            <section class="skill-grade-reference">
              <h3 class="section-header">Skill Grade</h3>
              <div class="grade-table">
                <div class="grade-row"><span>Automatic</span><span>‚Äì</span></div>
                <div class="grade-row"><span>Very Easy</span><span>+40%</span></div>
                <div class="grade-row"><span>Easy</span><span>+20%</span></div>
                <div class="grade-row"><span>Standard</span><span>‚Äì</span></div>
                <div class="grade-row"><span>Hard</span><span>-20%</span></div>
                <div class="grade-row"><span>Formidable</span><span>-40%</span></div>
                <div class="grade-row"><span>Herculean</span><span>-80%</span></div>
                <div class="grade-row"><span>Hopeless</span><span>‚Äì</span></div>
              </div>
            </section>
          </div>

          <!-- Center Column: Alignment, Passion, Oath, Professional Skills, Languages -->
          <div class="column-center">
            
            <!-- Alignment Section -->
            <section class="alignment-section">
              <div class="section-header-row">
                <h3 class="section-header">Alignment</h3>
                <div class="header-buttons">
                  <button type="button" class="btn btn-small btn-add-row" id="btn-add-alignment" title="Add alignment row">+</button>
                  <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-alignment" title="Remove last alignment row">‚àí</button>
                </div>
              </div>
              <div class="section-subheader">
                <span></span>
                <span></span>
                <span class="header-base">Base %</span>
                <span class="header-current">%</span>
              </div>
              <div id="alignment-container">
                <!-- Alignment rows are dynamically generated -->
              </div>
            </section>

            <!-- Passion Section -->
            <section class="passion-section">
              <div class="section-header-row">
                <h3 class="section-header">Passions</h3>
                <div class="header-buttons">
                  <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-passions" title="Sort alphabetically">A‚ÜíZ</button>
                  <button type="button" class="btn btn-small btn-add-row" id="btn-add-passion" title="Add passion row">+</button>
                  <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-passion" title="Remove last passion row">‚àí</button>
                </div>
              </div>
              <div class="section-subheader">
                <span></span>
                <span></span>
                <span class="header-base">Base %</span>
                <span class="header-current">%</span>
              </div>
              <div id="passions-container">
                <!-- Passion rows are dynamically generated -->
              </div>
            </section>

            <!-- Oath Section -->
            <section class="oath-section">
              <div class="section-header-row">
                <h3 class="section-header">Oaths</h3>
                <div class="header-buttons">
                  <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-oaths" title="Sort alphabetically">A‚ÜíZ</button>
                  <button type="button" class="btn btn-small btn-add-row" id="btn-add-oath" title="Add oath row">+</button>
                  <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-oath" title="Remove last oath row">‚àí</button>
                </div>
              </div>
              <div class="section-subheader">
                <span></span>
                <span></span>
                <span class="header-base">Base %</span>
                <span class="header-current">%</span>
              </div>
              <div id="oaths-container">
                <!-- Oath rows are dynamically generated -->
              </div>
            </section>

            <!-- Professional Skills Section -->
            <section class="skills-section professional-skills">
              <div class="section-header-row">
                <h3 class="section-header">Professional Skills</h3>
                <div class="header-buttons">
                  <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-prof" title="Sort alphabetically">A‚ÜíZ</button>
                  <button type="button" class="btn btn-small btn-add-row" id="btn-add-prof-skill" title="Add professional skill row">+</button>
                  <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-prof-skill" title="Remove last row">‚àí</button>
                </div>
              </div>
              <div class="skills-header prof-header">
                <span></span>
                <span></span>
                <span class="header-base">Base %</span>
                <span class="header-current">%</span>
              </div>
              <div id="professional-skills-container" class="scrollable-skills-container">
                <!-- Professional skills are dynamically generated -->
              </div>
            </section>

            <!-- Language Section -->
            <section class="language-section">
              <div class="section-header-row">
                <h3 class="section-header">Languages</h3>
                <div class="header-buttons">
                  <button type="button" class="btn btn-small btn-info-icon" id="btn-language-info" title="Language skill information">‚ÑπÔ∏è</button>
                  <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-languages" title="Sort alphabetically">A‚ÜíZ</button>
                  <button type="button" class="btn btn-small btn-add-row" id="btn-add-language" title="Add language row">+</button>
                  <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-language" title="Remove last row">‚àí</button>
                </div>
              </div>
              <div class="section-subheader">
                <span></span>
                <span></span>
                <span class="header-base">Base %</span>
                <span class="header-current">%</span>
              </div>
              <div id="language-container">
                <!-- Language rows are dynamically generated (native tongue always shown) -->
              </div>
            </section>
          </div>

          <!-- Right Column: Equipment -->
          <div class="column-right">
            <section class="equipment-section">
              <div class="section-header-row">
                <h3 class="section-header">Equipment</h3>
                <div class="header-buttons">
                  <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-equipment" title="Sort alphabetically">A‚ÜíZ</button>
                  <button type="button" class="btn btn-small btn-add-row" id="btn-add-equipment" title="Add equipment row">+</button>
                  <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-equipment" title="Remove last row">‚àí</button>
                </div>
              </div>
              <div class="equipment-header">
                <span class="header-item">Item</span>
                <span class="header-enc">ENC</span>
              </div>
              <div id="equipment-container" class="equipment-scrollable">
                <!-- Equipment rows are dynamically generated -->
              </div>
              
              <!-- Money Section -->
              <div class="money-section">
                <h4 class="money-header">Money</h4>
                <div class="money-grid">
                  <div class="money-row">
                    <label for="money-copper">Copper:</label>
                    <input type="number" id="money-copper" class="money-input" placeholder="0" min="0">
                  </div>
                  <div class="money-row">
                    <label for="money-silver">Silver:</label>
                    <input type="number" id="money-silver" class="money-input" placeholder="0" min="0">
                  </div>
                  <div class="money-row">
                    <label for="money-gold">Gold:</label>
                    <input type="number" id="money-gold" class="money-input" placeholder="0" min="0">
                  </div>
                  <div class="money-row">
                    <label for="money-platinum">Platinum:</label>
                    <input type="number" id="money-platinum" class="money-input" placeholder="0" min="0">
                  </div>
                  <div class="money-row">
                    <label for="money-electrum">Electrum:</label>
                    <input type="number" id="money-electrum" class="money-input" placeholder="0" min="0">
                  </div>
                </div>
              </div>
              
              <div class="enc-totals">
                <div class="enc-money-row">
                  <span class="enc-money-label">Money ENC:</span>
                  <span class="enc-money-value" id="money-enc">0</span>
                </div>
                <div class="enc-toggle">
                  <label>
                    <input type="checkbox" id="enc-automation-toggle">
                    <span>Toggle ENC Automation (Check=OFF)</span>
                  </label>
                </div>
                <div class="enc-status-row">
                  <span class="enc-status-label">Current ENC Status:</span>
                  <span class="enc-status-value" id="enc-status">Unburdened</span>
                </div>
                <div class="enc-total-row">
                  <span class="enc-total-label">Total ENC:</span>
                  <span class="enc-total-value" id="total-enc">0.0</span>
                </div>
              </div>
            </section>
            
            <!-- Container Buttons (dynamically shown based on equipment) -->
            <div class="container-buttons" id="container-buttons">
              <button type="button" class="btn btn-container hidden" id="btn-open-backpack" data-container="backpack">
                Backpack (10)
              </button>
              <button type="button" class="btn btn-container hidden" id="btn-open-reinforced-backpack" data-container="reinforced-backpack">
                Reinforced Backpack (15)
              </button>
              <button type="button" class="btn btn-container hidden" id="btn-open-large-sack" data-container="large-sack">
                Large Sack (10)
              </button>
              <button type="button" class="btn btn-container hidden" id="btn-open-small-sack" data-container="small-sack">
                Small Sack (3)
              </button>
              <button type="button" class="btn btn-container hidden" id="btn-open-satchel" data-container="satchel">
                Slingbag/Satchel (6)
              </button>
              <button type="button" class="btn btn-container hidden" id="btn-open-belt-pouch" data-container="belt-pouch">
                Belt Pouch (1)
              </button>
            </div>
          </div>
        </div>
      </div>
    </section>

    <!-- Container Modal Overlay (used for Backpack, Sacks, Satchel) -->
    <div id="container-modal" class="modal-overlay hidden">
      <div class="modal-content container-modal">
        <div class="modal-header">
          <h3 id="container-modal-title">Container Contents</h3>
          <div class="header-buttons container-header-buttons">
            <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-container" title="Sort alphabetically">A‚ÜíZ</button>
            <button type="button" class="btn btn-small btn-add-row" id="btn-add-container-row" title="Add row">+</button>
            <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-container-row" title="Remove last empty row">‚àí</button>
          </div>
          <button type="button" class="btn-modal-close" id="btn-close-container">&times;</button>
        </div>
        <div class="modal-body">
          <div class="container-capacity-bar">
            <span class="capacity-label">Capacity:</span>
            <span class="capacity-current" id="container-current-enc">0</span>
            <span class="capacity-separator">/</span>
            <span class="capacity-max" id="container-max-enc">10</span>
            <span class="capacity-unit">Things</span>
          </div>
          <div class="equipment-header">
            <span class="header-item">Item</span>
            <span class="header-enc">ENC</span>
          </div>
          <div id="container-items">
            <!-- Container rows are dynamically generated -->
          </div>
        </div>
        <div class="modal-footer">
          <button type="button" class="btn btn-primary" id="btn-save-container">Save & Close</button>
        </div>
      </div>
    </div>

    <!-- Heal All Confirmation Modal -->
    <div id="heal-all-modal" class="modal-overlay hidden">
      <div class="modal-content heal-modal">
        <div class="modal-header heal-modal-header">
          <h3>‚ù§Ô∏è‚Äçü©π Heal All Damage</h3>
          <button type="button" class="btn-modal-close" id="heal-modal-close">&times;</button>
        </div>
        <div class="modal-body heal-modal-body">
          <p>Are you sure you want to heal all damage?</p>
          <p class="heal-modal-note">This will restore all hit location Current HP to their maximum values.</p>
        </div>
        <div class="modal-footer heal-modal-footer">
          <button type="button" class="btn btn-secondary" id="btn-heal-cancel">Cancel</button>
          <button type="button" class="btn btn-heal-confirm" id="btn-heal-confirm">Yes, Heal All</button>
        </div>
      </div>
    </div>

    <!-- Wound Info Modal -->
    <div id="wound-info-modal" class="modal-overlay hidden">
      <div class="modal-content wound-info-modal">
        <div class="modal-header wound-info-header" id="wound-info-header">
          <h3 id="wound-info-title">Wound Information</h3>
          <button type="button" class="btn-modal-close" id="wound-info-close">&times;</button>
        </div>
        <div class="modal-body wound-info-body" id="wound-info-body">
          <!-- Content dynamically populated -->
        </div>
        <div class="modal-footer wound-info-footer">
          <button type="button" class="btn btn-secondary" id="btn-wound-info-close">Close</button>
        </div>
      </div>
    </div>

    <!-- New Game Modal -->
    <div id="new-game-modal" class="modal-overlay hidden">
      <div class="modal-content new-game-modal">
        <div class="modal-header new-game-modal-header">
          <h3>üé≤ New Game Session</h3>
          <button type="button" class="btn-modal-close" id="new-game-modal-close">&times;</button>
        </div>
        <div class="modal-body new-game-modal-body">
          <p class="new-game-message">Good luck adventuring!</p>
          <p class="new-game-effect">Your Luck Points have been restored to maximum.</p>
          <div class="new-game-luck-display">
            <span class="luck-icon">üçÄ</span>
            <span class="luck-value" id="new-game-luck-value">0</span>
            <span class="luck-label">Luck Points</span>
          </div>
        </div>
        <div class="modal-footer new-game-modal-footer">
          <button type="button" class="btn btn-primary" id="btn-new-game-ok">Let's Go!</button>
        </div>
      </div>
    </div>

    <!-- Finish Game Modal -->
    <div id="finish-game-modal" class="modal-overlay hidden">
      <div class="modal-content finish-game-modal">
        <div class="modal-header finish-game-modal-header">
          <h3>üèÜ Finish Game Session</h3>
          <button type="button" class="btn-modal-close" id="finish-game-modal-close">&times;</button>
        </div>
        <div class="modal-body finish-game-modal-body">
          <p class="finish-game-message">Great session! How many EXP Rolls did you gain?</p>
          <div class="finish-game-input-row">
            <label for="finish-game-exp">EXP Rolls Earned:</label>
            <input type="number" id="finish-game-exp" class="finish-game-exp-input" min="0" value="1" placeholder="0">
          </div>
          <div class="finish-game-summary">
            <span class="exp-current">Current: <strong id="finish-game-current-exp">0</strong></span>
            <span class="exp-arrow">‚Üí</span>
            <span class="exp-new">New Total: <strong id="finish-game-new-exp">0</strong></span>
          </div>
        </div>
        <div class="modal-footer finish-game-modal-footer">
          <button type="button" class="btn btn-secondary" id="btn-finish-game-cancel">Cancel</button>
          <button type="button" class="btn btn-finish-confirm" id="btn-finish-game-confirm">Save & Finish</button>
        </div>
      </div>
    </div>

    <!-- ==================== SPELL CASTING MODAL ==================== -->
    <div id="cast-modal" class="modal-overlay hidden">
      <div class="modal-content cast-modal-content" id="cast-modal-dialog">
        <!-- Casting type theme border (set via JS) -->
        <div class="cast-modal-theme-border" id="cast-modal-theme-border"></div>

        <!-- Animation Overlay (outside scroll area so it covers the whole modal) -->
        <div class="cast-animation-overlay hidden" id="cast-animation-overlay"></div>

        <!-- Scrollable content area -->
        <div class="cast-modal-scroll">

          <!-- Header -->
          <div class="cast-modal-header">
            <div class="cast-modal-title-row">
              <span class="cast-modal-school" id="cast-modal-school"></span>
              <h3 class="cast-modal-spell-name" id="cast-modal-spell-name"></h3>
              <span class="cast-modal-rank-badge" id="cast-modal-rank-badge"></span>
            </div>
            <button type="button" class="btn-modal-close" id="cast-modal-close">&times;</button>
          </div>

          <!-- Multiclass selector (hidden when only one class) -->
          <div class="cast-modal-class-select hidden" id="cast-class-select-row">
            <span class="cast-class-label">Cast as:</span>
            <div class="cast-class-options" id="cast-class-options"></div>
          </div>

          <!-- Stat Block -->
          <div class="cast-modal-stats">
            <div class="cast-stat-grid">
              <div class="cast-stat"><span class="cast-stat-label">Cost</span><span class="cast-stat-value" id="cast-stat-cost"></span></div>
              <div class="cast-stat"><span class="cast-stat-label">Area</span><span class="cast-stat-value" id="cast-stat-area"></span></div>
              <div class="cast-stat"><span class="cast-stat-label">Cast Time</span><span class="cast-stat-value" id="cast-stat-time"></span></div>
              <div class="cast-stat"><span class="cast-stat-label">Duration</span><span class="cast-stat-value" id="cast-stat-duration"></span></div>
              <div class="cast-stat"><span class="cast-stat-label">Range</span><span class="cast-stat-value" id="cast-stat-range"></span></div>
              <div class="cast-stat"><span class="cast-stat-label">Resist</span><span class="cast-stat-value" id="cast-stat-resist"></span></div>
            </div>
          </div>

          <!-- Intensity Controls (hidden for cantrips) -->
          <div class="cast-modal-intensity" id="cast-modal-intensity-section" style="display:none;">
            <div class="intensity-row">
              <span class="intensity-label">Intensity</span>
              <button type="button" class="btn-intensity" id="cast-intensity-down" title="Decrease intensity">&#9664;</button>
              <span class="intensity-value" id="cast-intensity-value">1</span>
              <button type="button" class="btn-intensity" id="cast-intensity-up" title="Increase intensity">&#9654;</button>
              <span class="intensity-max" id="cast-intensity-max">/1</span>
            </div>
            <div class="intensity-info-row">
              <span class="intensity-cost-display" id="cast-intensity-cost"></span>
              <span class="intensity-magnitude-display" id="cast-intensity-magnitude"></span>
            </div>
          </div>

          <!-- Sorcerer Weaving Controls (hidden for non-sorcery) -->
          <div class="cast-modal-weaving hidden" id="cast-weaving-section">
            <div class="weaving-header-row weaving-toggle" id="weaving-toggle">
              <span class="weaving-toggle-arrow" id="weaving-toggle-arrow">‚ñ∂</span>
              <span class="weaving-label">üåÄ Spell Weaving</span>
              <span class="weaving-max-note">(max 2, cannot combine with Intensity)</span>
            </div>
            <div class="weaving-body hidden" id="weaving-body">
            <div class="weaving-options" id="weaving-options">
              <label class="weaving-option" title="Increase damage/effect by half of rolled damage. +3 MP, Formidable difficulty, +1 Cast Time.">
                <input type="checkbox" class="weaving-check" data-weave="amplify" data-mp="3" data-difficulty="formidable">
                <span class="weaving-name">Amplify</span>
                <span class="weaving-cost">+3 MP</span>
                <span class="weaving-diff">Formidable</span>
              </label>
              <label class="weaving-option" title="Double the spell's duration. +1 MP, Hard difficulty, +1 Cast Time.">
                <input type="checkbox" class="weaving-check" data-weave="lingering" data-mp="1" data-difficulty="hard">
                <span class="weaving-name">Lingering</span>
                <span class="weaving-cost">+1 MP</span>
                <span class="weaving-diff">Hard</span>
              </label>
              <label class="weaving-option" title="Cast without verbal components. +1 MP, Hard difficulty, +1 Cast Time.">
                <input type="checkbox" class="weaving-check" data-weave="wordless" data-mp="1" data-difficulty="hard">
                <span class="weaving-name">Wordless</span>
                <span class="weaving-cost">+1 MP</span>
                <span class="weaving-diff">Hard</span>
              </label>
              <label class="weaving-option" title="Cast without somatic (hand) components. +1 MP, Hard difficulty, +1 Cast Time.">
                <input type="checkbox" class="weaving-check" data-weave="stillness" data-mp="1" data-difficulty="hard">
                <span class="weaving-name">Stillness</span>
                <span class="weaving-cost">+1 MP</span>
                <span class="weaving-diff">Hard</span>
              </label>
              <label class="weaving-option" title="Cast as 1 Action regardless of normal time. +4 MP, Herculean difficulty. No extra Cast Time.">
                <input type="checkbox" class="weaving-check" data-weave="quickening" data-mp="4" data-difficulty="herculean">
                <span class="weaving-name">Quickening</span>
                <span class="weaving-cost">+4 MP</span>
                <span class="weaving-diff">Herculean</span>
              </label>
              <label class="weaving-option" title="Double the area of effect or targets. +2 MP, Hard difficulty, +1 Cast Time.">
                <input type="checkbox" class="weaving-check" data-weave="expanding" data-mp="2" data-difficulty="hard">
                <span class="weaving-name">Expanding</span>
                <span class="weaving-cost">+2 MP</span>
                <span class="weaving-diff">Hard</span>
              </label>
            </div>
            <div class="weaving-summary hidden" id="weaving-summary">
              <span class="weaving-summary-cost" id="weaving-summary-cost"></span>
              <span class="weaving-summary-diff" id="weaving-summary-diff"></span>
              <span class="weaving-summary-time" id="weaving-summary-time"></span>
            </div>
            <div class="weaving-lock-note hidden" id="weaving-lock-note">
              ‚ö† Intensity is locked at 1 while Weaving is active.
            </div>
            </div><!-- end weaving-body -->
          </div>

          <!-- Armor Warning -->
          <div class="cast-modal-armor-warning hidden" id="cast-armor-warning">
            <span class="armor-warning-icon">&#9888;</span>
            <span class="armor-warning-text" id="cast-armor-warning-text"></span>
          </div>

          <!-- Non-Memorized Casting Info -->
          <div class="cast-modal-nonmem hidden" id="cast-nonmem-section">
            <div class="cast-nonmem-badge">NON-MEMORIZED</div>
            <div class="cast-nonmem-details">
              <span class="cast-nonmem-difficulty" id="cast-nonmem-difficulty"></span>
              <span class="cast-nonmem-time" id="cast-nonmem-time"></span>
            </div>
            <div class="cast-nonmem-rules" id="cast-nonmem-rules"></div>
          </div>

          <!-- Description (collapsible) -->
          <div class="cast-modal-description">
            <div class="cast-flavor-text" id="cast-flavor-text"></div>
            <button type="button" class="btn-toggle-desc" id="cast-toggle-desc">Show Full Description &#9660;</button>
            <div class="cast-full-desc hidden" id="cast-full-desc"></div>
          </div>

          <!-- Casting Controls -->
          <div class="cast-modal-casting" id="cast-modal-casting">
            <!-- Bard Sing Augment Option -->
            <div class="cast-sing-augment hidden" id="cast-sing-augment">
              <label class="cast-sing-label">
                <input type="checkbox" class="cast-sing-check" id="cast-sing-check">
                <span class="cast-sing-text">Use <strong>Sing</strong> to augment casting?</span>
                <span class="cast-sing-bonus" id="cast-sing-bonus"></span>
              </label>
            </div>

            <div class="cast-skill-row">
              <span class="cast-skill-name" id="cast-skill-name">Arcane Casting</span>
              <span class="cast-skill-percent" id="cast-skill-percent">72%</span>
              <span class="cast-difficulty-note" id="cast-difficulty-note"></span>
            </div>
            <div class="cast-mp-row">
              <span class="cast-mp-label">Magic Points</span>
              <span class="cast-mp-current" id="cast-mp-current">12</span>
              <span class="cast-mp-arrow">&rarr;</span>
              <span class="cast-mp-after" id="cast-mp-after">11</span>
            </div>
            <div class="cast-exp-row hidden" id="cast-exp-row">
              <span class="cast-exp-label">EXP Rolls</span>
              <span class="cast-exp-current" id="cast-exp-current">0</span>
              <span class="cast-exp-arrow">&rarr;</span>
              <span class="cast-exp-after" id="cast-exp-after">0</span>
              <span class="cast-exp-cost-note" id="cast-exp-note"></span>
            </div>

            <!-- MP Overcasting Warning -->
            <div class="cast-mp-warning hidden" id="cast-mp-warning" style="background: #4a1a1a; border: 1px solid #8b3a3a; border-radius: 6px; padding: 6px 10px; margin-bottom: 8px; font-size: 0.82em; color: #e8a0a0; text-align: center;">
              ‚ö†Ô∏è <span id="cast-mp-warning-text">Insufficient MP ‚Äî casting will cause Fatigue!</span>
            </div>

            <!-- Cast Button -->
            <button type="button" class="btn-cast-main" id="cast-modal-cast-btn">
              <span class="cast-btn-icon">&#10022;</span>
              <span class="cast-btn-text" id="cast-btn-text">Cast Spell</span>
            </button>
          </div>

          <!-- Roll Result (hidden until cast) -->
          <div class="cast-modal-result hidden" id="cast-modal-result">
            <div class="cast-roll-display">
              <span class="cast-roll-label">d100 Roll</span>
              <span class="cast-roll-number" id="cast-roll-number">00</span>
              <span class="cast-roll-target" id="cast-roll-target">vs 72%</span>
            </div>
            <div class="cast-result-banner" id="cast-result-banner">
              <span class="cast-result-text" id="cast-result-text">SUCCESS</span>
            </div>
            <div class="cast-result-details" id="cast-result-details"></div>

            <!-- Luck Point Section (shown on failure/fumble when luck > 0) -->
            <div class="cast-luck-section hidden" id="cast-luck-section">
              <div class="cast-luck-header">
                <span class="cast-luck-label">üçÄ Spend a Luck Point</span>
                <span class="cast-luck-remaining">(<span id="cast-luck-count">0</span> remaining)</span>
              </div>
              <div class="cast-luck-buttons">
                <button type="button" class="btn-luck-reroll" id="cast-luck-reroll" title="Re-roll the d100 ‚Äî must accept the new result">üé≤ Re-roll</button>
                <button type="button" class="btn-luck-swap" id="cast-luck-swap" title="Swap the tens and units digits of your roll">üîÑ Swap Digits <span class="luck-swap-preview" id="cast-luck-swap-preview"></span></button>
              </div>
              <div class="cast-luck-opponent-note">You may also spend a Luck Point to force an opponent to re-roll ‚Äî tell your GM.</div>
            </div>

            <!-- Force Failed Spell (hidden unless failed) -->
            <div class="cast-force-section hidden" id="cast-force-section">
              <p class="cast-force-explain">The spell fizzled. You may force it to succeed, but it will be expunged from memory.</p>
              <div class="cast-force-buttons">
                <button type="button" class="btn-force-spell" id="cast-force-btn">Force Spell</button>
              </div>
            </div>

            <!-- Close after result -->
            <button type="button" class="btn-cast-done" id="cast-done-btn">Done</button>
          </div>

        </div><!-- end cast-modal-scroll -->
      </div>
    </div>

    <!-- ==================== PAGE 3: COMBAT AND SPECIAL ABILITIES ==================== -->
    <section id="page-combat" class="sheet-page page-combat">
      <div class="page-content ornate-border">
        <h2 class="page-title">COMBAT</h2>
        
        <!-- Quick Reference Section -->
        <div class="combat-header-grid">
          <div class="quick-reference">
            <h3 class="section-header">Quick Reference Combat Attributes</h3>
            <div class="quick-ref-row">
              <div class="quick-ref-item">
                <span class="ref-label">Current Initiative</span>
                <span class="ref-value" id="combat-initiative"></span>
              </div>
              <div class="quick-ref-item">
                <span class="ref-label">Current Luck Points</span>
                <span class="ref-value" id="combat-luck"></span>
              </div>
              <div class="quick-ref-item">
                <span class="ref-label">Combat Skill</span>
                <span class="ref-value" id="combat-skill-ref"></span>
              </div>
              <div class="quick-ref-item">
                <span class="ref-label">Current Action Points</span>
                <span class="ref-value" id="combat-action-points"></span>
              </div>
              <div class="quick-ref-item">
                <span class="ref-label">Damage Modifier</span>
                <span class="ref-value" id="combat-damage-mod"></span>
              </div>
            </div>
            <div class="quick-ref-skills">
              <div class="ref-skill-row">
                <div class="ref-skill-item" id="ref-athletics">
                  <span class="ref-skill-label">Athletics</span>
                  <span class="ref-skill-value"></span>
                </div>
                <div class="ref-skill-item" id="ref-brawn">
                  <span class="ref-skill-label">Brawn</span>
                  <span class="ref-skill-value"></span>
                </div>
                <div class="ref-skill-item" id="ref-endurance">
                  <span class="ref-skill-label">Endurance</span>
                  <span class="ref-skill-value"></span>
                </div>
                <div class="ref-skill-item" id="ref-evade">
                  <span class="ref-skill-label">Evade</span>
                  <span class="ref-skill-value"></span>
                </div>
              </div>
              <div class="ref-skill-row">
                <div class="ref-skill-item" id="ref-perception">
                  <span class="ref-skill-label">Perception</span>
                  <span class="ref-skill-value"></span>
                </div>
                <div class="ref-skill-item" id="ref-stealth">
                  <span class="ref-skill-label">Stealth</span>
                  <span class="ref-skill-value"></span>
                </div>
                <div class="ref-skill-item" id="ref-swim">
                  <span class="ref-skill-label">Swim</span>
                  <span class="ref-skill-value"></span>
                </div>
                <div class="ref-skill-item" id="ref-willpower">
                  <span class="ref-skill-label">Willpower</span>
                  <span class="ref-skill-value"></span>
                </div>
              </div>
            </div>
          </div>

          <!-- Hit Locations -->
          <div class="hit-locations">
            <div class="section-header-row">
              <h3 class="section-header">Hit Locations</h3>
              <div class="header-buttons">
                <button type="button" class="btn btn-small btn-heal-all" id="btn-heal-all" title="Heal all locations to max HP">‚ù§Ô∏è‚Äçü©π Heal All</button>
              </div>
            </div>
            <table class="hit-location-table">
              <thead>
                <tr>
                  <th>1d20</th>
                  <th>Location</th>
                  <th>Armor</th>
                  <th>AP</th>
                  <th>HP / Current</th>
                  <th>Status</th>
                </tr>
              </thead>
              <tbody id="hit-locations-body">
                <!-- Hit locations are populated based on sheet type -->
              </tbody>
            </table>
          </div>
        </div>

        <!-- Combat Skills Section -->
        <div class="combat-skills-section">
          <div class="combat-skill-header">
            <span class="header-prereq"></span>
            <span class="header-label">Combat Skill</span>
            <span class="header-percent">%</span>
            <span class="header-dice"></span>
            <span class="header-enc"></span>
            <span class="header-weapons">Weapons Known</span>
            <span class="header-base">Base %</span>
          </div>
          <div class="combat-skill-row">
            <span class="prereq-keys" data-skill-name="Combat Skill"></span>
            <input type="text" class="combat-skill-name" id="combat-skill-1-name" placeholder="">
            <input type="number" class="combat-skill-percent enc-affected-combat" id="combat-skill-1-percent" placeholder="">
            <span class="enc-indicator" title="Affected by ENC"></span>
            <input type="text" class="combat-weapons-known" id="combat-skill-1-weapons" placeholder="">
            <span class="combat-base">STR+DEX</span>
          </div>
          <div class="combat-skill-row unarmed">
            <span class="prereq-keys" data-skill-name="Unarmed"></span>
            <span class="combat-skill-name">Unarmed</span>
            <input type="number" class="combat-skill-percent enc-affected-combat" id="unarmed-percent" placeholder="">
            <span class="enc-indicator" title="Affected by ENC"></span>
            <span class="combat-weapons-known">Hands/Feet</span>
            <span class="combat-base">STR+DEX</span>
          </div>
        </div>

        <!-- Melee Weapons Table -->
        <section class="weapons-section melee-weapons">
          <div class="section-header-row">
            <h3 class="section-header">Melee Weapons</h3>
            <div class="header-buttons">
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-melee" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row" id="btn-add-melee" title="Add melee weapon">+</button>
              <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-melee" title="Remove last empty row">‚àí</button>
            </div>
          </div>
          <table class="weapons-table">
            <thead>
              <tr>
                <th>Melee Weapon</th>
                <th>Hands</th>
                <th>Damage</th>
                <th>Size</th>
                <th>Combat Special Effects</th>
                <th>AP/HP</th>
                <th>Weapon Traits</th>
              </tr>
            </thead>
            <tbody id="melee-weapons-body">
              <!-- 6 melee weapon rows -->
            </tbody>
          </table>
        </section>

        <!-- Ranged Weapons Table -->
        <section class="weapons-section ranged-weapons">
          <div class="section-header-row">
            <h3 class="section-header">Ranged Weapons</h3>
            <div class="header-buttons">
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-ranged" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row" id="btn-add-ranged" title="Add ranged weapon">+</button>
              <button type="button" class="btn btn-small btn-remove-row" id="btn-remove-ranged" title="Remove last empty row">‚àí</button>
            </div>
          </div>
          <table class="weapons-table">
            <thead>
              <tr>
                <th>Ranged Weapon</th>
                <th>Hands</th>
                <th>Damage</th>
                <th>Damage Mod Y/N</th>
                <th>Range</th>
                <th>Load</th>
                <th>Special Effects</th>
                <th>Impale Size</th>
                <th>AP/HP</th>
                <th>Traits</th>
              </tr>
            </thead>
            <tbody id="ranged-weapons-body">
              <!-- 5 ranged weapon rows -->
            </tbody>
          </table>
        </section>

        <!-- Movement & Fatigue Grid -->
        <div class="movement-fatigue-grid">
          <!-- Movement Section -->
          <section class="movement-section">
            <h3 class="section-header">Movement</h3>
            <div class="movement-grid">
              <div class="movement-item">
                <span class="movement-label">Walk</span>
                <span class="movement-sublabel">(Base x1)</span>
                <span class="movement-value" id="walk-speed"></span>
              </div>
              <div class="movement-item">
                <span class="movement-label">Run</span>
                <span class="movement-sublabel">(Base x3)</span>
                <span class="movement-value" id="run-speed"></span>
              </div>
              <div class="movement-item">
                <span class="movement-label">Sprint</span>
                <span class="movement-sublabel">(Base x5)</span>
                <span class="movement-value" id="sprint-speed"></span>
              </div>
              <div class="movement-item">
                <span class="movement-label">Swim</span>
                <span class="movement-sublabel">(Base x1)</span>
                <span class="movement-value" id="swim-speed"></span>
              </div>
              <div class="movement-item">
                <span class="movement-label">Climb</span>
                <span class="movement-sublabel">(Base x1)</span>
                <span class="movement-value" id="climb-speed"></span>
              </div>
            </div>
            <div class="jump-grid">
              <div class="movement-item">
                <span class="movement-label">Vertical Jump</span>
                <span class="movement-sublabel">(1/2 Height)</span>
                <span class="movement-value" id="vertical-jump"></span>
              </div>
              <div class="movement-item">
                <span class="movement-label">Horizontal Jump</span>
                <span class="movement-sublabel">(2x Height)</span>
                <span class="movement-value" id="horizontal-jump"></span>
              </div>
              <div class="movement-item syrin-only">
                <span class="movement-label">Other Movement</span>
                <span class="movement-sublabel">(Flying)</span>
                <input type="text" class="movement-value-input" id="flying-speed" placeholder="">
              </div>
            </div>
          </section>

          <!-- Fatigue States Reference -->
          <section class="fatigue-section">
            <h3 class="section-header">Fatigue States</h3>
            <table class="fatigue-table">
              <thead>
                <tr>
                  <th class="fatigue-col-radio"></th>
                  <th class="fatigue-col-state">State</th>
                  <th class="fatigue-col-skills">Skills</th>
                  <th class="fatigue-col-movement">Movement</th>
                  <th class="fatigue-col-initiative">Initiative</th>
                  <th class="fatigue-col-ap">AP</th>
                  <th class="fatigue-col-recovery">Recovery</th>
                </tr>
              </thead>
              <tbody>
                <tr data-fatigue="fresh" class="fatigue-active"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="fresh" checked></td><td class="fatigue-state-name">Fresh</td><td>‚Äì</td><td>‚Äì</td><td>‚Äì</td><td>‚Äì</td><td>‚Äì</td></tr>
                <tr data-fatigue="winded"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="winded"></td><td class="fatigue-state-name">Winded</td><td>Hard</td><td>‚Äì</td><td>‚Äì</td><td>‚Äì</td><td>15 min.</td></tr>
                <tr data-fatigue="tired"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="tired"></td><td class="fatigue-state-name">Tired</td><td>Hard</td><td>-5 ft.</td><td>‚Äì</td><td>‚Äì</td><td>3 Hrs.</td></tr>
                <tr data-fatigue="wearied"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="wearied"></td><td class="fatigue-state-name">Wearied</td><td>Formidable</td><td>-5 ft.</td><td>-2</td><td>‚Äì</td><td>6 Hrs.</td></tr>
                <tr data-fatigue="exhausted"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="exhausted"></td><td class="fatigue-state-name">Exhausted</td><td>Formidable</td><td>1/2</td><td>-4</td><td>-1</td><td>12 Hrs.</td></tr>
                <tr data-fatigue="debilitated"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="debilitated"></td><td class="fatigue-state-name">Debilitated</td><td>Herculean</td><td>1/2</td><td>-6</td><td>-2</td><td>18 Hrs.</td></tr>
                <tr data-fatigue="incapacitated"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="incapacitated"></td><td class="fatigue-state-name">Incapacitated</td><td>Herculean</td><td>Immobile</td><td>-8</td><td>-3</td><td>24 Hrs.</td></tr>
                <tr data-fatigue="semiconscious"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="semiconscious"></td><td class="fatigue-state-name">Semi-conscious</td><td>Hopeless</td><td>N/A</td><td>N/A</td><td>N/A</td><td>36 Hrs.</td></tr>
                <tr data-fatigue="coma"><td class="fatigue-radio-cell"><input type="radio" name="fatigue-state" value="coma"></td><td class="fatigue-state-name">Coma</td><td>N/A</td><td>N/A</td><td>N/A</td><td>N/A</td><td>48 Hrs.</td></tr>
              </tbody>
            </table>
          </section>
        </div>

        <!-- Special Abilities Title -->
        <h2 class="page-title special-abilities-title">SPECIAL ABILITIES</h2>

        <!-- Abilities Sections Container (single column layout) -->
        <div class="abilities-sections-container">
          <!-- Class Abilities Section -->
          <section class="class-abilities-section">
            <div class="section-header-row">
              <h3 class="section-header">Class Abilities</h3>
              <div class="header-buttons">
                <button type="button" class="btn btn-small btn-alphabetize" id="btn-sort-abilities" title="Sort all abilities alphabetically">A‚ÜíZ</button>
              </div>
            </div>
            <!-- Hidden text list for data tracking -->
            <div class="class-abilities-list" id="class-abilities-list" style="display: none;">
              <!-- Dynamically populated -->
            </div>

            <!-- Interactive ability button sections -->
            <div class="ability-cards-grid" id="ability-buttons-area">
              <!-- ===== SPECIES ABILITIES (dynamically injected as sections) ===== -->
              <!-- ===== ABILITY BUTTONS (Toggle/Activate) ===== -->
              <section class="berserk-rage-section" id="berserk-rage-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚öîÔ∏è Berserk Rage</h3>
                </div>
                <div class="berserk-rage-content">
                  <div class="rage-info-row">
                    <span class="rage-value" id="rage-uses-available">0</span>
                    <span class="rage-label">/</span>
                    <span class="rage-value" id="rage-uses-max">0</span>
                    <span class="rage-label">uses ‚Ä¢</span>
                    <span class="rage-value" id="rage-rounds-max">0</span>
                    <span class="rage-label">rds</span>
                    <button type="button" class="btn btn-small btn-reset-rage" id="btn-reset-rage-uses" title="Reset uses to maximum">‚Ü∫</button>
                  </div>
                  <div class="rage-button-row">
                    <button type="button" class="btn btn-rage" id="btn-rage-toggle" title="Berserk Rage: Enter a battle frenzy ‚Äî Damage Modifier +1 step, Endurance/Willpower +20%, Brawn +40%, Evade ‚àí20%">
                      <span class="rage-text" id="rage-btn-text">Rage!</span>
                    </button>
                  </div>
                  <div class="rage-tracker" id="rage-tracker" style="display: none;">
                    <div class="rage-active-label">üî• RAGE ACTIVE üî•</div>
                    <div class="rage-rounds-row">
                      <span class="rage-label">Rounds Used:</span>
                      <input type="number" class="rage-rounds-input" id="rage-rounds-used" value="0" min="0">
                      <span class="rage-label">/ <span id="rage-rounds-total">0</span></span>
                    </div>
                    <div class="rage-effects-summary">
                      <div class="rage-effect" id="rage-effect-dmg">Damage Mod: +1 step</div>
                      <div class="rage-effect">Endurance: +20%</div>
                      <div class="rage-effect">Willpower: +20%</div>
                      <div class="rage-effect">Brawn: +40%</div>
                      <div class="rage-effect rage-penalty">Evade: -20%</div>
                    </div>
                    <button type="button" class="btn btn-end-rage" id="btn-end-rage" title="End Rage: Remove rage bonuses and gain 1 Fatigue Level">End Rage (1 Fatigue Level)</button>
                  </div>
                </div>
              </section>

              <section class="brute-strength-section" id="brute-strength-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üí™ Brute Strength</h3>
                </div>
                <div class="brute-strength-content">
                  <div class="brute-strength-info">
                    <span class="brute-label">+20% Brawn ‚Ä¢ Fatigue</span>
                  </div>
                  <div class="brute-strength-toggle">
                    <button type="button" class="btn btn-brute" id="btn-brute-toggle" title="Brute Strength: Increase Damage Modifier one step at the cost of one Difficulty Grade on your attack">
                      <span class="brute-text" id="brute-btn-text">Use</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="climb-walls-section" id="climb-walls-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üßó Climb Walls</h3>
                </div>
                <div class="climb-walls-content">
                  <div class="climb-walls-info">
                    <span class="climb-walls-label" id="climb-walls-status">+20% Athletics ¬∑ Unburdened + Light armor</span>
                  </div>
                  <button type="button" class="btn btn-climb-walls" id="btn-climb-walls-toggle" title="Climb Walls: Ignore 1 Grade of Difficulty on Athletics when climbing (Unburdened + Light armor only)">
                    üßó Climb Walls
                  </button>
                </div>
              </section>

              <section class="commanding-section" id="commanding-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üëë Commanding</h3>
                </div>
                <div class="commanding-content">
                  <div class="commanding-info-row">
                    <span class="commanding-value" id="commanding-uses-available">0</span>
                    <span class="commanding-label">/ <span id="commanding-uses-max">0</span> uses/day ¬∑ +40% bonus</span>
                    <button type="button" class="btn btn-small btn-reset-commanding" id="btn-reset-commanding-uses" title="Reset uses to maximum">‚Ü∫</button>
                  </div>
                  <div class="commanding-button-row" id="commanding-buttons">
                    <button type="button" class="btn btn-commanding" id="btn-commanding-insight" title="Commanding Insight: Gain +40% bonus to Insight for the next check">
                      Insight
                    </button>
                    <button type="button" class="btn btn-commanding" id="btn-commanding-influence" title="Commanding Influence: Gain +40% bonus to Influence for the next check">
                      Influence
                    </button>
                  </div>
                  <div class="commanding-active" id="commanding-active" style="display: none;">
                    <div class="commanding-active-label">üëë <span id="commanding-active-skill">Skill</span> +40% üëë</div>
                    <button type="button" class="btn btn-end-commanding" id="btn-end-commanding" title="End Commanding Presence: Remove the skill bonus">Done</button>
                  </div>
                </div>
              </section>

              <section class="cure-disease-section" id="cure-disease-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">ü©∫ Cure Disease</h3>
                </div>
                <div class="cure-disease-content">
                  <div class="cure-disease-info-row">
                    <span class="cure-disease-value" id="cure-disease-uses-available">0</span>
                    <span class="cure-disease-label">/ <span id="cure-disease-uses-max">0</span> uses/week</span>
                    <button type="button" class="btn btn-small btn-reset-cure-disease" id="btn-reset-cure-disease-uses" title="Reset uses (after 1 week / 7 Long Rests)">‚Ü∫</button>
                  </div>
                  <div class="cure-disease-button-row">
                    <button type="button" class="btn btn-cure-disease" id="btn-cure-disease-use" title="Remove one natural disease from a sick individual">
                      ü©∫ Cure Disease
                    </button>
                  </div>
                  <div id="cure-disease-rest-tracker" style="display: none; margin-top: 0.3rem; text-align: center; font-size: 0.72rem; color: #999;">
                    Long Rests: <strong id="cure-disease-rest-count">0</strong> / 7
                    <button type="button" class="btn btn-small" id="btn-cure-disease-rest" style="font-size: 0.65rem; padding: 0.1rem 0.3rem; margin-left: 0.3rem; border: 1px solid #555; background: none; color: #aaa; border-radius: 3px; cursor: pointer;">+1 Rest</button>
                  </div>
                </div>
              </section>

              <section class="detect-evil-section" id="detect-evil-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üëÅÔ∏è Detect Evil</h3>
                </div>
                <div class="detect-evil-content">
                  <div class="detect-evil-info" style="text-align:center;">
                    <span class="detect-evil-label" style="color:#9a7acc; font-size:0.72rem; font-style:italic;">Concentrate 1 Round ¬∑ 60ft range</span>
                  </div>
                  <div class="detect-evil-button-row">
                    <button type="button" class="btn btn-detect-evil" id="btn-detect-evil-use" title="Concentrate for 1 Round to detect Evil within 60 feet">
                      Use
                    </button>
                  </div>
                </div>
              </section>

              <section class="detect-magic-section" id="detect-magic-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚ú® Detect Magic</h3>
                </div>
                <div class="detect-magic-content">
                  <div class="detect-magic-info">
                    <span class="detect-magic-label">Willpower roll to sense magic</span>
                  </div>
                    <button type="button" class="btn btn-detect-magic" id="btn-detect-magic-use" title="Roll Willpower to detect magical auras, areas, or items">
                    Use
                  </button>
                </div>
              </section>

              <section class="determination-section" id="determination-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üî• Determination</h3>
                </div>
                <div class="determination-content">
                  <div class="determination-info">
                    <span class="determination-label">Ignore Serious Wounds & Fatigue via Oath</span>
                  </div>
                  <button type="button" class="btn btn-determination" id="btn-determination-use" title="Roll against an Oath to push through injury or exhaustion">
                    Roll Determination
                  </button>
                </div>
              </section>

              <section class="call-war-horse-section" id="call-war-horse-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üê¥ Call War Horse</h3>
                </div>
                <div class="call-war-horse-content">
                  <div class="call-war-horse-info">
                    <span class="call-war-horse-label">Summon your celestial war horse</span>
                  </div>
                  <button type="button" class="btn btn-call-war-horse" id="btn-call-war-horse" title="Summon your bonded celestial war horse">
                    üê¥ Summon Steed
                  </button>
                </div>
              </section>

              <section class="alter-self-section" id="alter-self-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üé≠ Alter Self</h3>
                </div>
                <div class="alter-self-content">
                  <div class="alter-self-info">
                    <span class="alter-self-label">Change form at will ¬∑ SIZ ¬±50%</span>
                  </div>
                  <button type="button" class="btn btn-alter-self" id="btn-alter-self" title="Alter your appearance to any humanoid-shaped biped">
                    üé≠ Shift Form
                  </button>
                </div>
              </section>

              <section class="divine-protection-section" id="divine-protection-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üõ°Ô∏è Divine Protection</h3>
                </div>
                <div class="divine-protection-content">
                  <div class="divine-protection-info">
                    <span class="divine-prot-label">+10% Willpower, Endurance & Evade</span>
                  </div>
                  <div class="divine-protection-toggle">
                    <button type="button" class="btn btn-divine-protection" id="btn-divine-protection-toggle" title="Divine Protection: Reduce damage from one attack per round by 2 (Heavy armor) or 1 (Light armor), per Rank">
                      <span id="divine-prot-btn-text">Activate</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="forceful-strike-section" id="forceful-strike-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚ö° Forceful Strike</h3>
                </div>
                <div class="forceful-strike-content">
                  <div class="forceful-strike-info">
                    <span class="forceful-label">-20% skill ‚Ä¢ +2 dmg</span>
                  </div>
                  <div class="forceful-strike-toggle">
                    <button type="button" class="btn btn-forceful" id="btn-forceful-toggle" title="Forceful Strike: Increase Damage Modifier two steps ‚Äî attack is one Difficulty Grade harder">
                      Activate
                    </button>
                  </div>
                </div>
              </section>

              <section class="great-hearing-section" id="great-hearing-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üëÇ Great Hearing</h3>
                </div>
                <div class="great-hearing-content">
                  <div class="great-hearing-info">
                    <span class="great-hearing-label">+20% Perception ¬∑ Hearing-related rolls</span>
                  </div>
                  <button type="button" class="btn btn-great-hearing" id="btn-great-hearing-toggle" title="Great Hearing: Perception rolls related to hearing are 1 Difficulty Grade easier">
                    üëÇ Great Hearing
                  </button>
                </div>
              </section>

              <section class="hide-in-shadows-section" id="hide-in-shadows-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üåë Hide in Shadows</h3>
                </div>
                <div class="hide-in-shadows-content">
                  <div class="hide-in-shadows-info">
                    <span class="hide-in-shadows-label">+20% Stealth ¬∑ In shadow or darkness</span>
                  </div>
                  <button type="button" class="btn btn-hide-in-shadows" id="btn-hide-in-shadows-toggle" title="Hide in Shadows: Enemy Perception rolls are 1 Difficulty Grade harder when in shadow or darkness">
                    üåë Hide in Shadows
                  </button>
                </div>
              </section>

              <section class="holy-smite-section" id="holy-smite-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header" id="holy-smite-header">‚öîÔ∏è Holy Smite</h3>
                </div>
                <div class="holy-smite-content">
                  <div class="holy-smite-info-row">
                    <span class="holy-smite-value" id="holy-smite-uses-available">1</span>
                    <span class="holy-smite-label">/ <span id="holy-smite-uses-max">1</span> uses/day</span>
                    <button type="button" class="btn btn-small btn-reset-holy-smite" id="btn-reset-holy-smite-uses" title="Reset uses to maximum">‚Ü∫</button>
                  </div>
                  <div class="holy-smite-bonus-row">
                    <span class="holy-smite-bonus" id="holy-smite-bonus">+1 step damage modifier vs Evil</span>
                  </div>
                  <div class="holy-smite-toggle">
                    <button type="button" class="btn btn-holy-smite" id="btn-holy-smite-toggle" title="Holy Smite: Increase Damage Modifier one step against evil creatures">
                      <span class="holy-smite-text" id="holy-smite-btn-text">Activate</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="holy-strike-section" id="holy-strike-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚öîÔ∏è Holy Strike</h3>
                </div>
                <div class="holy-strike-content">
                  <div class="holy-strike-info-row">
                    <span class="holy-strike-value" id="holy-strike-uses-available">0</span>
                    <span class="holy-strike-label">/ <span id="holy-strike-uses-max">0</span> uses/day</span>
                    <button type="button" class="btn btn-small btn-reset-holy-strike" id="btn-reset-holy-strike-uses" title="Reset uses to maximum">‚Ü∫</button>
                  </div>
                  <div class="holy-strike-button-row">
                    <button type="button" class="btn btn-holy-strike" id="btn-holy-strike-use" title="Activate Holy Strike ‚Äî adds +1d6 holy damage to next melee attack">
                      ‚öîÔ∏è Holy Strike (+1d6)
                    </button>
                  </div>
                </div>
              </section>

              <section class="improved-aim-section" id="improved-aim-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üéØ Improved Aim</h3>
                </div>
                <div class="improved-aim-content">
                  <div class="improved-aim-info">
                    <span class="improved-aim-label">Within Effective Range ¬∑ 1 Turn to steady</span>
                  </div>
                  <button type="button" class="btn btn-improved-aim" id="btn-improved-aim" title="Improved Aim: Within Effective Range, Aiming requires only 1 Turn and makes the attack 1 Difficulty Grade easier">
                    üéØ Improved Aim
                  </button>
                </div>
              </section>

              <section class="just-a-scratch-section" id="just-a-scratch-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">ü©π Just a Scratch</h3>
                </div>
                <div class="just-a-scratch-content">
                  <div class="scratch-info-row">
                    <span class="scratch-value" id="scratch-uses-available">1</span>
                    <span class="scratch-label">/ 1 use</span>
                    <button type="button" class="btn btn-small btn-reset-scratch" id="btn-reset-scratch-uses" title="Reset uses to maximum">‚Ü∫</button>
                  </div>
                  <div class="scratch-button-row">
                    <button type="button" class="btn btn-scratch" id="btn-scratch-use" title="Just a Scratch: Shake off a wound ‚Äî roll Endurance to recover Hit Points">
                      <span class="scratch-text" id="scratch-btn-text">Use</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="lay-on-hands-section" id="lay-on-hands-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üôå Lay on Hands</h3>
                </div>
                <div class="lay-on-hands-content">
                  <div class="lay-on-hands-info-row">
                    <span class="lay-on-hands-value" id="lay-on-hands-uses-available">0</span>
                    <span class="lay-on-hands-label">/ <span id="lay-on-hands-uses-max">0</span> uses/day</span>
                    <button type="button" class="btn btn-small btn-reset-lay-on-hands" id="btn-reset-lay-on-hands-uses" title="Reset uses to maximum">‚Ü∫</button>
                  </div>
                  <div class="lay-on-hands-button-row">
                    <button type="button" class="btn btn-lay-on-hands" id="btn-lay-on-hands-use" title="Heal Minor Wound (all HP) or stabilize Serious/Major Wound">
                      üôå Lay on Hands
                    </button>
                  </div>
                </div>
              </section>

              <section class="mental-strength-section" id="mental-strength-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üß† Mental Strength</h3>
                </div>
                <div class="mental-strength-content">
                  <div class="mental-strength-info-row">
                    <span class="mental-strength-value" id="mental-strength-uses-available">0</span>
                    <span class="mental-strength-label">/ <span id="mental-strength-uses-max">0</span> uses/day ¬∑ +40% Willpower</span>
                    <button type="button" class="btn btn-small btn-reset-mental-strength" id="btn-reset-mental-strength-uses" title="Reset uses to maximum">‚Ü∫</button>
                  </div>
                  <div class="mental-strength-button-row" id="mental-strength-buttons">
                    <button type="button" class="btn btn-mental-strength" id="btn-mental-strength-use" title="Mental Strength: Willpower checks vs mind magic are 2 grades easier; Disbelieve Illusions/Phantasms is 1 grade easier">
                      Resist Mind Magic
                    </button>
                  </div>
                  <div class="mental-strength-active" id="mental-strength-active" style="display: none;">
                    <div class="mental-strength-active-label">üß† Willpower +40% üß†</div>
                    <div class="mental-strength-effects">
                      <span>vs Mind Magic</span>
                    </div>
                    <button type="button" class="btn btn-end-mental-strength" id="btn-end-mental-strength" title="End Mental Strength: Remove the Willpower bonus vs mind-affecting magic">Done</button>
                  </div>
                </div>
              </section>

              <section class="just-a-scratch-section" id="mystic-healing-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üßò Mystic Healing</h3>
                </div>
                <div class="just-a-scratch-content">
                  <div class="scratch-info-row">
                    <span class="scratch-value" id="mystic-healing-remaining">0</span>
                    <span class="scratch-label">/ <span id="mystic-healing-pool">0</span> HP remaining today</span>
                    <button type="button" class="btn btn-small btn-reset-scratch" id="btn-reset-mystic-healing" title="Reset daily pool">‚Ü∫</button>
                  </div>
                  <div class="scratch-button-row">
                    <button type="button" class="btn btn-scratch" id="btn-mystic-healing-use" title="Mystic Healing: Meditate to heal wounds ‚Äî recover Hit Points through focused meditation">
                      <span class="scratch-text">Meditate & Heal</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="just-a-scratch-section" id="nether-walk-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üåÄ Nether Walk</h3>
                </div>
                <div class="just-a-scratch-content">
                  <div class="scratch-info-row">
                    <span class="scratch-value" id="nether-walk-distance">0</span>
                    <span class="scratch-label">ft teleport</span>
                    <span style="margin: 0 0.3rem; color: #666;">‚Ä¢</span>
                    <span class="scratch-value" id="nether-walk-uses">1</span>
                    <span class="scratch-label">/ 1 use today</span>
                    <button type="button" class="btn btn-small btn-reset-scratch" id="btn-reset-nether-walk" title="Reset daily use">‚Ü∫</button>
                  </div>
                  <div class="scratch-button-row">
                    <button type="button" class="btn btn-scratch" id="btn-nether-walk-use" style="background: #7c4dff;" title="Nether Walk: Teleport a short distance (1/10th Mysticism skill in feet) once per day">
                      <span class="scratch-text">‚ú® Nether Walk</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="just-a-scratch-section" id="pain-control-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üß† Pain Control</h3>
                </div>
                <div class="just-a-scratch-content">
                  <div class="scratch-info-row">
                    <span class="scratch-label" style="font-size: 0.72rem;">Auto-Success Endurance (fail only on 100)</span>
                  </div>
                  <div class="scratch-button-row">
                    <button type="button" class="btn btn-scratch" id="btn-pain-control-roll" title="Pain Control: Roll Endurance to ignore the effects of a Serious Wound for a number of rounds">
                      <span class="scratch-text">Roll Endurance</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="just-a-scratch-section" id="perfection-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚ú® Perfection</h3>
                </div>
                <div class="just-a-scratch-content">
                  <div class="scratch-info-row">
                    <span class="scratch-label" style="font-size: 0.72rem;">Ethereal Rounds: <strong id="perfection-rounds">20</strong> / 20 today</span>
                    <button type="button" class="btn btn-small btn-reset-scratch" id="btn-reset-perfection" title="Reset daily rounds">‚Ü∫</button>
                  </div>
                  <div class="scratch-button-row">
                    <button type="button" class="btn btn-scratch" id="btn-perfection-toggle" style="background: #1a237e;" title="Perfection: Enhance all combat rolls ‚Äî your attacks and defenses are one Difficulty Grade easier">
                      <span class="scratch-text" id="perfection-btn-text">Activate Perfection</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="powerful-concentration-section" id="powerful-concentration-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üß† Powerful Concentration</h3>
                </div>
                <div class="powerful-concentration-content">
                  <div class="powerful-concentration-description">
                    You possess exceptional focus when casting spells. <strong>Willpower tests to maintain Concentration</strong> for spells or spellcasting are one Difficulty Grade easier. Click to activate when casting.
                  </div>
                  <div class="powerful-concentration-toggle">
                    <button type="button" class="btn btn-powerful-concentration" id="btn-powerful-concentration-toggle" title="Powerful Concentration: +20 Willpower for maintaining concentration on spells">
                      <span id="powerful-concentration-btn-text">Activate (+20 Willpower)</span>
                    </button>
                  </div>
                </div>
              </section>

              <section class="just-a-scratch-section" id="quivering-palm-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üíÄ Quivering Palm</h3>
                </div>
                <div class="just-a-scratch-content">
                  <div class="scratch-info-row">
                    <span class="scratch-label" style="font-size: 0.72rem;" id="qp-status-text">Ready</span>
                    <span style="margin: 0 0.3rem; color: #666;">‚Ä¢</span>
                    <span class="scratch-label" style="font-size: 0.72rem;">Max SIZ: <strong id="qp-max-siz">0</strong></span>
                    <button type="button" class="btn btn-small btn-reset-scratch" id="btn-reset-qp" title="Reset (after 1 week / 7 Long Rests)">‚Ü∫</button>
                  </div>
                  <div class="scratch-button-row" style="display: flex; gap: 0.4rem; justify-content: center;">
                    <button type="button" class="btn btn-scratch" id="btn-qp-initiate" style="background: #880e4f;" title="Quivering Palm: Initiate deadly vibrations ‚Äî you have 3 rounds to touch the victim">
                      <span class="scratch-text">Initiate</span>
                    </button>
                    <button type="button" class="btn btn-scratch" id="btn-qp-trigger" style="background: #4a148c; display: none;" title="Quivering Palm: Trigger the fatal vibrations ‚Äî roll Mysticism ‚àí20% to kill the target">
                      <span class="scratch-text">Trigger Death</span>
                    </button>
                  </div>
                  <div id="qp-rest-tracker" style="display: none; margin-top: 0.3rem; text-align: center; font-size: 0.72rem; color: #999;">
                    Long Rests: <strong id="qp-rest-count">0</strong> / 7
                    <button type="button" class="btn btn-small" id="btn-qp-rest" style="font-size: 0.65rem; padding: 0.1rem 0.3rem; margin-left: 0.3rem; border: 1px solid #555; background: none; color: #aaa; border-radius: 3px; cursor: pointer;">+1 Rest</button>
                  </div>
                </div>
              </section>

              <section class="read-languages-section" id="read-languages-pending-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üìú Read Languages</h3>
                </div>
                <div class="read-languages-content">
                  <div class="read-languages-label">Requires one month of thieves' guild training</div>
                  <button type="button" class="btn btn-read-languages" id="btn-complete-rl-training" title="Confirm guild training completed">
                    üìú Complete Guild Training
                  </button>
                </div>
              </section>

              <section class="shape-change-section" id="shape-change-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üê∫ Shape Change</h3>
                </div>
                <div class="shape-change-content">
                  <div class="shape-change-info-row">
                    <span class="shape-change-value" id="shape-change-uses-available">0</span>
                    <span class="shape-change-label">/ <span id="shape-change-uses-max">0</span> uses/day</span>
                    <button type="button" class="btn btn-small btn-reset-shape-change" id="btn-reset-shape-change-uses" title="Reset uses (new day)">‚Ü∫</button>
                  </div>
                  <div class="shape-change-tier-info">
                    <span class="shape-change-tier" id="shape-change-tier-label">Shape Change I</span>
                    <span class="shape-change-duration" id="shape-change-duration">Duration: 5 hrs</span>
                  </div>
                  <div class="shape-change-button-row">
                    <button type="button" class="btn btn-shape-change" id="btn-shape-change-use" title="Transform into an animal form">
                      üê∫ Shape Change
                    </button>
                  </div>
                </div>
              </section>

              <section class="sharp-eyed-section" id="sharp-eyed-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üëÅÔ∏è Sharp Eyed</h3>
                </div>
                <div class="sharp-eyed-content">
                  <div class="sharp-eyed-info">
                    <span class="sharp-eyed-label">+20% Perception ¬∑ Vision-related rolls</span>
                  </div>
                  <button type="button" class="btn btn-sharp-eyed" id="btn-sharp-eyed-toggle" title="Sharp Eyed: Perception rolls related to vision are 1 Difficulty Grade easier">
                    üëÅÔ∏è Sharp Eyed
                  </button>
                </div>
              </section>

              <section class="stealthy-section" id="stealthy-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">ü•∑ Stealthy</h3>
                </div>
                <div class="stealthy-content">
                  <div class="stealthy-info">
                    <span class="stealthy-label" id="stealthy-status">+20% Stealth ¬∑ Light armor or less</span>
                  </div>
                  <button type="button" class="btn btn-stealthy" id="btn-stealthy-toggle" title="Stealthy: Stealth rolls are 1 Difficulty Grade easier when wearing Light armor or less">
                    ü•∑ Stealthy
                  </button>
                </div>
              </section>

              <section class="sneak-attack-section" id="sneak-attack-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üó°Ô∏è Sneak Attack</h3>
                </div>
                <div class="sneak-attack-content">
                  <div class="sneak-attack-card">
                    <div class="sneak-attack-req"><strong>Weapon:</strong> Small/Medium melee or ranged within 30 ft</div>
                    <div class="sneak-attack-req"><strong>Target:</strong> Humanoid with vital organs ‚Ä¢ Must be outside target's field of vision</div>
                    <div class="sneak-attack-divider"></div>
                    <div class="sneak-attack-effect"><strong>On Success:</strong> Bonus <em>Choose Location</em> SE (head/chest/abdomen):</div>
                    <div class="sneak-attack-bullets">
                      <span>‚Ä¢ Ignore negative Damage Modifiers</span>
                      <span>‚Ä¢ Bypass Armor & Maximize Damage don't require Critical</span>
                    </div>
                    <div class="sneak-attack-divider"></div>
                    <div class="sneak-attack-defense">
                      <strong>Detecting:</strong> Perception roll (Hard if distracted)<br>
                      <strong>Defending from side:</strong> Formidable &nbsp;|&nbsp; <strong>From behind:</strong> Herculean
                    </div>
                    <!-- Sneak Attack Bonus Damage (Rank 2+) -->
                    <div class="sneak-attack-bonus-area" id="sneak-attack-bonus-area" style="display: none;">
                      <div class="sneak-attack-divider"></div>
                      <div class="sneak-attack-bonus-label" id="sneak-attack-bonus-label"></div>
                      <button type="button" class="btn btn-sneak-damage" id="btn-sneak-attack-damage" title="Apply Sneak Attack bonus damage to weapons">
                        üó°Ô∏è Apply Bonus Damage
                      </button>
                    </div>
                  </div>
                </div>
              </section>

              <section class="species-enemy-section" id="species-enemy-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header" id="species-enemy-header">üéØ Species Enemy</h3>
                </div>
                <div class="species-enemy-content">
                  <div class="species-enemy-list" id="species-enemy-list"></div>
                  <button type="button" class="btn btn-species-enemy" id="btn-species-enemy" title="Species Enemy: +10% to all skill rolls and Damage Modifier +1 step vs your chosen enemy">
                    üéØ Activate Species Enemy
                  </button>
                </div>
              </section>

              <section class="turn-undead-section" id="turn-undead-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚òÄÔ∏è Turn Undead</h3>
                </div>
                <div class="turn-undead-content">
                  <div class="turn-undead-info-row">
                    <span class="turn-undead-value" id="turn-undead-uses-available">0</span>
                    <span class="turn-undead-label">/ <span id="turn-undead-uses-max">0</span> per encounter</span>
                    <button type="button" class="btn btn-small btn-reset-turn-undead" id="btn-reset-turn-undead-uses" title="Reset uses (new encounter)">‚Ü∫</button>
                  </div>
                  <div class="turn-undead-button-row" id="turn-undead-buttons">
                    <button type="button" class="btn btn-turn-undead" id="btn-turn-undead-use" title="Turn Undead: Channel divine power to drive off or destroy undead, demons, or devils">
                      ‚òÄÔ∏è Turn Undead
                    </button>
                  </div>
                </div>
              </section>

              <section class="vaulting-section" id="vaulting-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üèÉ Vaulting</h3>
                </div>
                <div class="vaulting-content">
                  <div class="vaulting-info">
                    <span class="vaulting-label" id="vaulting-status">+20% Acrobatics ¬∑ Unburdened + pole required</span>
                  </div>
                  <button type="button" class="btn btn-vaulting" id="btn-vaulting-toggle" title="Vaulting: Easy Acrobatics roll (+20%) to pole vault ‚Äî horizontal: 2x height + 1d4+6 ft, vertical: staff length">
                    üèÉ Vault
                  </button>
                </div>
              </section>

              <!-- ===== INFO SECTIONS (Passive/Informational) ===== -->
              <section class="animal-companion-section" id="animal-companion-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üêæ Animal Companion</h3>
                </div>
                <div class="animal-companion-content">
                  <div class="companion-tier-info">
                    <span class="companion-tier-label" id="companion-tier-label">Tier I</span>
                    <span class="companion-siz-limit" id="companion-siz-limit">Max SIZ: 35</span>
                  </div>
                  <div class="companion-list" id="companion-list">
                    <p class="no-companions">No companions yet. Use Spend XP Rolls to add one.</p>
                  </div>
                </div>
              </section>

              <section class="arcane-scrolls-section" id="arcane-scrolls-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üìú Use Arcane Scrolls</h3>
                </div>
                <div class="arcane-scrolls-content">
                  <div class="arcane-scrolls-card">
                    <div>Cast spells from mage scrolls without Read Magic. Success chance: <strong>INT x5 = <span id="arcane-scroll-chance">‚Äî</span>%</strong></div>
                    <div class="arcane-scrolls-warning">‚ö† Failure automatically results in a Fumble ‚Äî spell backfires!</div>
                    <button type="button" class="btn btn-arcane-scroll-roll" id="btn-arcane-scroll-roll" title="Roll d100 against INT x5">
                      üé≤ Roll Arcane Scroll (d100)
                    </button>
                  </div>
                </div>
              </section>

              <section class="circle-of-power-section" id="circle-of-power-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üîµ Circle of Power</h3>
                </div>
                <div class="circle-of-power-content">
                  <div class="circle-of-power-info">
                    <span class="cop-label">Holy Weapon Required</span>
                  </div>
                  <div class="circle-of-power-detail">
                    <span class="cop-text">Suppresses hostile magic up to Magnitude</span>
                    <span class="cop-magnitude" id="cop-magnitude-value">0</span>
                  </div>
                  <div class="circle-of-power-note">
                    <span class="cop-formula">(Channel <span id="cop-channel-value">0</span>% √∑ 10, rounded up)</span>
                  </div>
                </div>
              </section>

              <section class="familiar-section" id="familiar-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üêæ Familiar</h3>
                </div>
                <div class="familiar-content">
                  <div class="familiar-type-row">
                    <span class="familiar-type-label">Familiar Type:</span>
                    <span class="familiar-type-value" id="familiar-type-display">Not yet chosen</span>
                    <button type="button" class="btn btn-small btn-choose-familiar" id="btn-choose-familiar" title="Choose or change your familiar type">‚úèÔ∏è</button>
                  </div>
                  <div class="familiar-info-details">
                    <div class="familiar-info-item">üîó Telepathic link within 120 ft</div>
                    <div class="familiar-info-item">‚ú® Can draw on familiar's Magic Points when within 120 ft</div>
                    <div class="familiar-info-item">üé≤ Roll on Familiars Table to determine type (subtract 5% per Rank above 1)</div>
                    <div class="familiar-info-item familiar-warning">‚ö† If the familiar dies, the sorcerer loses 5 Experience Rolls</div>
                  </div>
                  <div class="familiar-note">
                    No summoning ritual required ‚Äî the familiar is naturally drawn to the sorcerer's raw magical power. Bond costs 1 EXP Roll (waived if starting at Rank 1+).
                  </div>
                </div>
              </section>

              <section class="magic-surge-section" id="magic-surge-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚ö° Magic Surge</h3>
                </div>
                <div class="magic-surge-content">
                  <div class="magic-surge-info-row">
                    <span class="magic-surge-value" id="magic-surge-uses">1</span>
                    <span class="magic-surge-label">/ 1 use/day</span>
                    <button type="button" class="btn btn-small btn-reset-scratch" id="btn-reset-magic-surge" title="Reset daily use">‚Ü∫</button>
                  </div>
                  <div class="magic-surge-button-row">
                    <button type="button" class="btn btn-magic-surge" id="btn-magic-surge-use" title="Magic Surge: Regain 1d6 Magic Points (costs 1 AP in combat)">
                      ‚ö° Surge Magic Points
                    </button>
                  </div>
                </div>
              </section>

              <section class="defensive-reflexes-section" id="defensive-reflexes-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚ö° Defensive Reflexes</h3>
                </div>
                <div class="defensive-reflexes-content">
                  <div class="dr-info-row">
                    <span class="dr-bonus-value" id="dr-bonus-ap">+1</span>
                    <span class="dr-bonus-label">Bonus Reactive AP</span>
                  </div>
                  <div class="dr-uses-row">
                    <span class="dr-uses-label" id="dr-uses-label">1 reaction per combat</span>
                  </div>
                  <div class="dr-rules">
                    <span>Parry/Evade only ¬∑ No re-rolling same attack ¬∑ Cannot combine with Luck Point</span>
                  </div>
                </div>
              </section>

              <section class="skirmishing-section" id="skirmishing-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üèπ Skirmishing</h3>
                </div>
                <div class="skirmishing-content">
                  <div class="skirmishing-card">
                    Ranged attacks while running (not sprinting). Combat Skill capped by Athletics (<span class="skirmish-athletics-val" id="skirmish-athletics-val">‚Äî</span>%).
                  </div>
                </div>
              </section>

              <section class="swashbuckling-section" id="swashbuckling-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">‚öîÔ∏è Swashbuckling</h3>
                </div>
                <div class="swashbuckling-content">
                  <div class="swashbuckling-card">
                    Attack & Evade while jumping/swinging into or out of combat. Ignores Athletics skill cap. Requires Unburdened + Light armor.
                  </div>
                </div>
              </section>

              <section class="unarmored-defense-section" id="unarmored-defense-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üõ°Ô∏è Unarmored Defense</h3>
                </div>
                <div class="unarmored-defense-content">
                  <div class="unarmored-defense-info">
                    <span class="unarmored-defense-label" id="unarmored-defense-status">+20% Evade ¬∑ No armor + Unburdened (auto)</span>
                  </div>
                </div>
              </section>

              <section class="weapon-precision-section" id="weapon-precision-section" style="display: none;">
                <div class="section-header-row">
                  <h3 class="section-header">üéØ Weapon Precision</h3>
                </div>
                <div class="weapon-precision-content">
                  <div class="weapon-precision-card">
                    <div class="wp-calc-row">
                      <span class="wp-calc-label">STR+DEX DM:</span>
                      <span class="wp-calc-value" id="wp-str-dex-dm">‚Äî</span>
                      <span class="wp-calc-sep">vs</span>
                      <span class="wp-calc-label">STR+SIZ DM:</span>
                      <span class="wp-calc-value" id="wp-str-siz-dm">‚Äî</span>
                      <span class="wp-active-indicator" id="wp-active-indicator"></span>
                    </div>
                    <div class="wp-weapons-list">Clubs, daggers, garrotes, knives, shortswords, main gauche, rapiers, unarmed, darts, slings, short bows, javelins</div>
                  </div>
                </div>
              </section>

            </div>

            <!-- Divider between buttons and info cards -->
            <hr class="special-abilities-divider" id="buttons-infocards-divider">

            <!-- Passive ability info cards -->
            <div class="ability-info-cards-grid" id="ability-info-cards-area">
              <!-- Dynamically populated info cards -->
            </div>

            <!-- Monk Abilities Section (only visible for Monk class) -->
            <hr class="ability-cards-divider" id="monk-abilities-divider" style="display: none;">
            <section class="weapon-spec-section" id="monk-abilities-section" style="display: none;">
              <div class="section-header-row weapon-spec-header">
                <h3 class="section-header">ü•ã Monk Abilities</h3>
                <button type="button" class="btn-collapse-toggle" id="monk-abilities-toggle" title="Expand/Collapse">
                  <span class="collapse-icon">‚ñº</span>
                </button>
              </div>
              <div class="weapon-spec-content collapsible" id="monk-abilities-content">
                <div class="weapon-spec-cards" id="monk-abilities-cards">
                  <!-- Monk ability cards populated dynamically -->
                </div>
              </div>
            </section>

            <hr class="ability-cards-divider" id="spell-like-divider" style="display: none;">

            <!-- Spell-Like Abilities Section (only visible if character has Spell-Like Abilities) -->
            <section class="spell-like-section" id="spell-like-section" style="display: none;">
              <div class="section-header-row spell-like-header">
                <h3 class="section-header" id="spell-like-title">Spell</h3>
                <button type="button" class="btn-collapse-toggle" id="spell-like-toggle" title="Expand/Collapse">
                  <span class="collapse-icon">‚ñº</span>
                </button>
              </div>
              <div class="spell-like-content collapsible" id="spell-like-content">
                <div class="spell-like-description" id="spell-like-description">
                  <!-- Spell description will be populated dynamically -->
                </div>
              </div>
            </section>

            <!-- Weapon Specialization Section (only visible if character has Weapon Specialization) -->
            <hr class="ability-cards-divider" id="weapon-spec-divider" style="display: none;">
            <section class="weapon-spec-section" id="weapon-spec-section" style="display: none;">
              <div class="section-header-row weapon-spec-header">
                <h3 class="section-header">‚öîÔ∏è Weapon Specializations</h3>
                <button type="button" class="btn-collapse-toggle" id="weapon-spec-toggle" title="Expand/Collapse">
                  <span class="collapse-icon">‚ñº</span>
                </button>
              </div>
              <div class="weapon-spec-content collapsible" id="weapon-spec-content">
                <div class="weapon-spec-cards" id="weapon-spec-cards">
                  <!-- Weapon specialization cards will be populated dynamically -->
                </div>
              </div>
            </section>
            
            <!-- Syrin Species Abilities Section (only visible for Syrin species) -->
            <hr class="ability-cards-divider" id="syrin-abilities-divider" style="display: none;">
            <div class="syrin-abilities-row" id="syrin-abilities-section" style="display: none;">
              <!-- Diving Strike -->
              <section class="syrin-ability-section diving-strike-section" id="diving-strike-section">
                <div class="section-header-row">
                  <h3 class="section-header">ü¶Ö Diving Strike</h3>
                </div>
                <div class="syrin-ability-content">
                  <div class="syrin-ability-info-row">
                    <span class="syrin-ability-value" id="diving-strike-uses">1</span>
                    <span class="syrin-ability-label">/ 1 per round</span>
                    <button type="button" class="btn btn-small btn-reset-syrin" id="btn-reset-diving-strike" title="Reset (new round)">‚Ü∫</button>
                  </div>
                  <div class="syrin-ability-button-row" id="diving-strike-buttons">
                    <button type="button" class="btn btn-syrin-ability btn-diving-strike" id="btn-diving-strike" title="Diving Strike: Increase Damage Modifier one step">
                      ü¶Ö Activate
                    </button>
                  </div>
                  <div class="syrin-ability-active" id="diving-strike-active" style="display: none;">
                    <div class="syrin-active-label">ü¶Ö Active ü¶Ö</div>
                    <button type="button" class="btn btn-end-syrin" id="btn-end-diving-strike" title="End Diving Strike: Remove the damage bonus and return to normal">End</button>
                  </div>
                </div>
              </section>
              
              <!-- Radiant Burst -->
              <section class="syrin-ability-section radiant-burst-section" id="radiant-burst-section">
                <div class="section-header-row">
                  <h3 class="section-header">üí´ Radiant Burst</h3>
                </div>
                <div class="syrin-ability-content">
                  <div class="syrin-ability-info-row">
                    <span class="syrin-ability-cost">1 AP, 1 MP</span>
                  </div>
                  <div class="syrin-ability-button-row">
                    <button type="button" class="btn btn-syrin-ability btn-radiant-burst" id="btn-radiant-burst" title="Radiant Burst: Burst in luminous energy to daze enemies">
                      üí´ Activate
                    </button>
                  </div>
                </div>
              </section>
            </div>

          </section>

          <!-- Divider before Species Abilities -->
          <hr class="special-abilities-divider">

          <!-- Species Abilities Section -->
          <section class="species-abilities-section" id="species-abilities-section">
            <div class="section-header-row">
              <h3 class="section-header">Species Abilities</h3>
              <div class="header-buttons">
                <button type="button" class="btn btn-small btn-alphabetize" id="btn-sort-species-abilities" title="Sort species abilities alphabetically">A‚ÜíZ</button>
              </div>
            </div>
            <div class="species-abilities-fullwidth" id="species-abilities-cards">
              <!-- Dynamically populated based on species -->
            </div>
          </section>

        </div>
      </div>
    </section>

    <!-- ==================== PAGE 4: MAGIC (Cantrips, Rank 1-2) ==================== -->
    <section id="page-magic1" class="sheet-page page-magic">
      <div class="page-content ornate-border">
        <h2 class="page-title">MAGIC AND SPELLS</h2>
        
        <!-- Magic Points Display Bar -->
        <div class="magic-mp-bar">
          <span class="magic-mp-label">Magic Points</span>
          <input type="number" class="magic-mp-current" id="magic-mp-display-1" value="0" min="0">
          <span class="magic-mp-separator">/</span>
          <span class="magic-mp-max" id="magic-mp-max-display-1">0</span>
        </div>
        
        <!-- Magic Skills Table -->
        <section class="magic-skills-section">
          <h3 class="section-header">Magic Skills</h3>
          <table class="magic-skills-table">
            <thead>
              <tr>
                <th>Class</th>
                <th>Casting Skill</th>
                <th>Base %</th>
                <th>%</th>
                <th>Knowledge Skill</th>
                <th>Base %</th>
                <th>%</th>
                <th class="magic-deity-col">Deity/ies</th>
              </tr>
            </thead>
            <tbody>
              <tr class="magic-class-divine">
                <td>Divine <span class="class-note">(Cleric, Ranger, Paladin, etc.)</span></td>
                <td><span class="casting-skill-name">Channel</span><span class="prereq-key-slot" data-skill="channel"></span></td>
                <td class="base-calc">INT+POW</td>
                <td><input type="number" id="channel-percent" class="magic-skill-input" placeholder=""></td>
                <td><span class="casting-skill-name">Piety</span><span class="prereq-key-slot" data-skill="piety"></span></td>
                <td class="base-calc">CHA+POW</td>
                <td><input type="number" id="piety-percent" class="magic-skill-input" placeholder=""></td>
                <td class="magic-deity-col"><input type="text" id="deity-name-magic" class="deity-input deity-mirror" data-sync="deity-name" placeholder=""></td>
              </tr>
              <tr class="magic-class-mage human-only">
                <td>Mage</td>
                <td><span class="casting-skill-name">Arcane Casting</span><span class="prereq-key-slot" data-skill="arcane-casting"></span></td>
                <td class="base-calc">INT+POW</td>
                <td><input type="number" id="arcane-casting-percent" class="magic-skill-input" placeholder=""></td>
                <td><span class="casting-skill-name">Arcane Knowledge</span><span class="prereq-key-slot" data-skill="arcane-knowledge"></span></td>
                <td class="base-calc">INT x2</td>
                <td><input type="number" id="arcane-knowledge-percent" class="magic-skill-input" placeholder=""></td>
                <td class="magic-deity-col"></td>
              </tr>
              <tr class="magic-class-sorcerer human-only">
                <td>Sorcerer</td>
                <td><span class="casting-skill-name">Arcane Sorcery</span><span class="prereq-key-slot" data-skill="arcane-sorcery"></span></td>
                <td class="base-calc">CHA+POW</td>
                <td><input type="number" id="arcane-sorcery-percent" class="magic-skill-input" placeholder=""></td>
                <td><span class="casting-skill-name">Sorcerous Wisdom</span><span class="prereq-key-slot" data-skill="sorcerous-wisdom"></span></td>
                <td class="base-calc">CHA+INT</td>
                <td><input type="number" id="sorcerous-wisdom-percent" class="magic-skill-input" placeholder=""></td>
                <td class="magic-deity-col"></td>
              </tr>
              <tr class="magic-class-bard">
                <td>Bard</td>
                <td><span class="casting-skill-name">Musicianship</span><span class="prereq-key-slot" data-skill="musicianship"></span></td>
                <td class="base-calc">DEX+CHA</td>
                <td><input type="number" id="musicianship-percent" class="magic-skill-input" placeholder=""></td>
                <td><span class="casting-skill-name">Lyrical Magic</span><span class="prereq-key-slot" data-skill="lyrical-magic"></span></td>
                <td class="base-calc">CHA+POW</td>
                <td><input type="number" id="lyrical-magic-percent" class="magic-skill-input" placeholder=""></td>
                <td class="magic-deity-col"></td>
              </tr>
            </tbody>
          </table>
          <p class="syrin-note syrin-only">Syrin may not become Mages or Sorcerers</p>
        </section>

        <!-- Rank 1 Paladin/Ranger cannot cast magic note -->
        <div class="rank1-spell-note" id="rank1-spell-note" style="display: none;">
          <span class="rank1-spell-note-icon">üö´</span>
          <span class="rank1-spell-note-text" id="rank1-spell-note-text"></span>
        </div>

        <!-- Spell Lists -->
        <div class="spell-columns">
          <!-- Cantrips -->
          <section class="spell-column cantrips">
            <div class="spell-header-row">
              <h3 class="spell-rank-header">Cantrips</h3>
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-cantrips" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row btn-add-spell-row" data-rank="cantrips" title="Add spell row">+</button>
              <button type="button" class="btn btn-small btn-remove-row btn-remove-spell-row" data-rank="cantrips" title="Remove last spell row">‚àí</button>
            </div>
            <div class="memorize-count">
              May Memorize <input type="number" id="cantrips-max" class="memorize-input" value="0" readonly> Spells
            </div>
            <table class="spell-table">
              <thead>
                <tr>
                  <th class="col-memorized">M</th>
                  <th class="col-spell">Spell</th>
                  <th class="col-cost">Magic Point Cost</th>
                  <th class="col-cast">Cast</th>
                </tr>
              </thead>
              <tbody id="cantrips-body">
                <!-- Cantrip rows generated dynamically -->
              </tbody>
            </table>
          </section>

          <!-- Rank 1 Spells -->
          <section class="spell-column rank1">
            <div class="spell-header-row">
              <h3 class="spell-rank-header">Rank 1 Spells</h3>
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-rank1" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row btn-add-spell-row" data-rank="rank1" title="Add spell row">+</button>
              <button type="button" class="btn btn-small btn-remove-row btn-remove-spell-row" data-rank="rank1" title="Remove last spell row">‚àí</button>
            </div>
            <div class="memorize-count">
              May Memorize <input type="number" id="rank1-max" class="memorize-input" value="0" readonly> Spells
            </div>
            <table class="spell-table">
              <thead>
                <tr>
                  <th class="col-memorized">M</th>
                  <th class="col-spell">Spell</th>
                  <th class="col-cost">Magic Point Cost</th>
                  <th class="col-cast">Cast</th>
                </tr>
              </thead>
              <tbody id="rank1-body">
                <!-- Rank 1 spell rows generated dynamically -->
              </tbody>
            </table>
          </section>

          <!-- Rank 2 Spells -->
          <section class="spell-column rank2">
            <div class="spell-header-row">
              <h3 class="spell-rank-header">Rank 2 Spells</h3>
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-rank2" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row btn-add-spell-row" data-rank="rank2" title="Add spell row">+</button>
              <button type="button" class="btn btn-small btn-remove-row btn-remove-spell-row" data-rank="rank2" title="Remove last spell row">‚àí</button>
            </div>
            <div class="memorize-count">
              May Memorize <input type="number" id="rank2-max" class="memorize-input" value="0" readonly> Spells
            </div>
            <table class="spell-table">
              <thead>
                <tr>
                  <th class="col-memorized">M</th>
                  <th class="col-spell">Spell</th>
                  <th class="col-cost">Magic Point Cost</th>
                  <th class="col-cast">Cast</th>
                </tr>
              </thead>
              <tbody id="rank2-body">
                <!-- Rank 2 spell rows generated dynamically -->
              </tbody>
            </table>
          </section>
        </div>

        <!-- Sorcerer Weaving Effects Chart (visible only for Sorcerer class) -->
        <section class="weaving-effects-section" id="weaving-effects-section-1" style="display: none;">
          <h3 class="section-header">üåÄ Sorcerer Spell Weaving</h3>
          <p class="weaving-intro">Sorcerers may weave additional effects into their spells at the cost of extra Magic Points, casting time, and increased Arcane Sorcery difficulty.</p>
          <table class="weaving-table">
            <thead>
              <tr>
                <th>Weaving Effect</th>
                <th>Additional Casting Time*</th>
                <th>Arcane Sorcery Difficulty**</th>
                <th>Extra MP Cost</th>
              </tr>
            </thead>
            <tbody>
              <tr><td><strong>Amplify</strong> <span class="weaving-desc">(Increase damage/effect by half of rolled damage)</span></td><td>+1 to Cast Time</td><td>Formidable</td><td>+3</td></tr>
              <tr><td><strong>Lingering</strong> <span class="weaving-desc">(Double duration)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+1</td></tr>
              <tr><td><strong>Wordless</strong> <span class="weaving-desc">(No verbal components)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+1</td></tr>
              <tr><td><strong>Stillness</strong> <span class="weaving-desc">(No somatic components)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+1</td></tr>
              <tr><td><strong>Quickening</strong> <span class="weaving-desc">(Cast as 1 Action)</span></td><td>‚Äî</td><td>Herculean</td><td>+4</td></tr>
              <tr><td><strong>Expanding</strong> <span class="weaving-desc">(Doubles the area of effect)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+2</td></tr>
            </tbody>
          </table>
          <div class="weaving-footnotes">
            <p class="weaving-footnote">* Added to the spell's existing Cast Time. For example, a spell with Cast Time 2 Actions becomes 3 Actions; 10 minutes becomes 11 minutes. For spells with multiple Cast Times (such as Fly: 10 minutes/Intensity +1d6√ó10 minutes), roll first then add one. Combining two weaves (e.g. Wordless + Stillness) adds +2, so Cast Time 2 Actions becomes 4 Actions.</p>
            <p class="weaving-footnote">** The Difficulty Grade Penalty affects the range of the Arcane Sorcery roll. For example, Tormos is tied up and unable to use his hands. He has Arcane Sorcery at 54% and wants to use Stillness. His difficulty grade becomes Hard, so his Arcane Sorcery skill becomes 34% for the purposes of a possible Arcane Flux. Should he fail his roll at 54 or higher (the minor Arcane Flux range ‚Äî 20% above), he may need to roll on the appropriate Arcane Flux effects table.</p>
          </div>
        </section>

      </div>
    </section>

    <!-- ==================== PAGE 5: MAGIC (Rank 3-5) ==================== -->
    <section id="page-magic2" class="sheet-page page-magic">
      <div class="page-content ornate-border">
        <h2 class="page-title">MAGIC AND SPELLS</h2>
        
        <!-- Magic Points Display Bar -->
        <div class="magic-mp-bar">
          <span class="magic-mp-label">Magic Points</span>
          <input type="number" class="magic-mp-current" id="magic-mp-display-2" value="0" min="0">
          <span class="magic-mp-separator">/</span>
          <span class="magic-mp-max" id="magic-mp-max-display-2">0</span>
        </div>
        
        <!-- Magic Skills Table (Editable, syncs with page 1) -->
        <section class="magic-skills-section">
          <h3 class="section-header">Magic Skills</h3>
          <table class="magic-skills-table">
            <thead>
              <tr>
                <th>Class</th>
                <th>Casting Skill</th>
                <th>Base %</th>
                <th>%</th>
                <th>Knowledge Skill</th>
                <th>Base %</th>
                <th>%</th>
                <th class="magic-deity-col">Deity/ies</th>
              </tr>
            </thead>
            <tbody>
              <tr class="magic-class-divine">
                <td>Divine <span class="class-note">(Cleric, Ranger, Paladin, etc.)</span></td>
                <td><span class="casting-skill-name">Channel</span><span class="prereq-key-slot" data-skill="channel"></span></td>
                <td class="base-calc">INT+POW</td>
                <td><input type="number" id="channel-percent-p2" class="magic-skill-input sync-magic" data-sync="channel-percent" placeholder=""></td>
                <td><span class="casting-skill-name">Piety</span><span class="prereq-key-slot" data-skill="piety"></span></td>
                <td class="base-calc">CHA+POW</td>
                <td><input type="number" id="piety-percent-p2" class="magic-skill-input sync-magic" data-sync="piety-percent" placeholder=""></td>
                <td class="magic-deity-col"><input type="text" id="deity-name-magic-p2" class="deity-input deity-mirror" data-sync="deity-name" placeholder=""></td>
              </tr>
              <tr class="magic-class-mage human-only">
                <td>Mage</td>
                <td><span class="casting-skill-name">Arcane Casting</span><span class="prereq-key-slot" data-skill="arcane-casting"></span></td>
                <td class="base-calc">INT+POW</td>
                <td><input type="number" id="arcane-casting-percent-p2" class="magic-skill-input sync-magic" data-sync="arcane-casting-percent" placeholder=""></td>
                <td><span class="casting-skill-name">Arcane Knowledge</span><span class="prereq-key-slot" data-skill="arcane-knowledge"></span></td>
                <td class="base-calc">INT x2</td>
                <td><input type="number" id="arcane-knowledge-percent-p2" class="magic-skill-input sync-magic" data-sync="arcane-knowledge-percent" placeholder=""></td>
                <td class="magic-deity-col"></td>
              </tr>
              <tr class="magic-class-sorcerer human-only">
                <td>Sorcerer</td>
                <td><span class="casting-skill-name">Arcane Sorcery</span><span class="prereq-key-slot" data-skill="arcane-sorcery"></span></td>
                <td class="base-calc">CHA+POW</td>
                <td><input type="number" id="arcane-sorcery-percent-p2" class="magic-skill-input sync-magic" data-sync="arcane-sorcery-percent" placeholder=""></td>
                <td><span class="casting-skill-name">Sorcerous Wisdom</span><span class="prereq-key-slot" data-skill="sorcerous-wisdom"></span></td>
                <td class="base-calc">CHA+INT</td>
                <td><input type="number" id="sorcerous-wisdom-percent-p2" class="magic-skill-input sync-magic" data-sync="sorcerous-wisdom-percent" placeholder=""></td>
                <td class="magic-deity-col"></td>
              </tr>
              <tr class="magic-class-bard">
                <td>Bard</td>
                <td><span class="casting-skill-name">Musicianship</span><span class="prereq-key-slot" data-skill="musicianship"></span></td>
                <td class="base-calc">DEX+CHA</td>
                <td><input type="number" id="musicianship-percent-p2" class="magic-skill-input sync-magic" data-sync="musicianship-percent" placeholder=""></td>
                <td><span class="casting-skill-name">Lyrical Magic</span><span class="prereq-key-slot" data-skill="lyrical-magic"></span></td>
                <td class="base-calc">CHA+POW</td>
                <td><input type="number" id="lyrical-magic-percent-p2" class="magic-skill-input sync-magic" data-sync="lyrical-magic-percent" placeholder=""></td>
                <td class="magic-deity-col"></td>
              </tr>
            </tbody>
          </table>
          <p class="syrin-note syrin-only">Syrin may not become Mages or Sorcerers</p>
        </section>

        <!-- Spell Lists -->
        <div class="spell-columns">
          <!-- Rank 3 Spells -->
          <section class="spell-column rank3">
            <div class="spell-header-row">
              <h3 class="spell-rank-header">Rank 3 Spells</h3>
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-rank3" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row btn-add-spell-row" data-rank="rank3" title="Add spell row">+</button>
              <button type="button" class="btn btn-small btn-remove-row btn-remove-spell-row" data-rank="rank3" title="Remove last spell row">‚àí</button>
            </div>
            <div class="memorize-count">
              May Memorize <input type="number" id="rank3-max" class="memorize-input" value="0" readonly> Spells
            </div>
            <table class="spell-table">
              <thead>
                <tr>
                  <th class="col-memorized">M</th>
                  <th class="col-spell">Spell</th>
                  <th class="col-cost">Magic Point Cost</th>
                  <th class="col-cast">Cast</th>
                </tr>
              </thead>
              <tbody id="rank3-body">
                <!-- Rank 3 spell rows generated dynamically -->
              </tbody>
            </table>
          </section>

          <!-- Rank 4 Spells -->
          <section class="spell-column rank4">
            <div class="spell-header-row">
              <h3 class="spell-rank-header">Rank 4 Spells</h3>
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-rank4" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row btn-add-spell-row" data-rank="rank4" title="Add spell row">+</button>
              <button type="button" class="btn btn-small btn-remove-row btn-remove-spell-row" data-rank="rank4" title="Remove last spell row">‚àí</button>
            </div>
            <div class="memorize-count">
              May Memorize <input type="number" id="rank4-max" class="memorize-input" value="0" readonly> Spells
            </div>
            <table class="spell-table">
              <thead>
                <tr>
                  <th class="col-memorized">M</th>
                  <th class="col-spell">Spell</th>
                  <th class="col-cost">Magic Point Cost</th>
                  <th class="col-cast">Cast</th>
                </tr>
              </thead>
              <tbody id="rank4-body">
                <!-- Rank 4 spell rows generated dynamically -->
              </tbody>
            </table>
          </section>

          <!-- Rank 5 Spells -->
          <section class="spell-column rank5">
            <div class="spell-header-row">
              <h3 class="spell-rank-header">Rank 5 Spells</h3>
              <button type="button" class="btn btn-small btn-alphabetize" id="btn-alphabetize-rank5" title="Sort alphabetically">A‚ÜíZ</button>
              <button type="button" class="btn btn-small btn-add-row btn-add-spell-row" data-rank="rank5" title="Add spell row">+</button>
              <button type="button" class="btn btn-small btn-remove-row btn-remove-spell-row" data-rank="rank5" title="Remove last spell row">‚àí</button>
            </div>
            <div class="memorize-count">
              May Memorize <input type="number" id="rank5-max" class="memorize-input" value="0" readonly> Spells
            </div>
            <table class="spell-table">
              <thead>
                <tr>
                  <th class="col-memorized">M</th>
                  <th class="col-spell">Spell</th>
                  <th class="col-cost">Magic Point Cost</th>
                  <th class="col-cast">Cast</th>
                </tr>
              </thead>
              <tbody id="rank5-body">
                <!-- Rank 5 spell rows generated dynamically -->
              </tbody>
            </table>
          </section>
        </div>

        <!-- Sorcerer Weaving Effects Chart (visible only for Sorcerer class) -->
        <section class="weaving-effects-section" id="weaving-effects-section-2" style="display: none;">
          <h3 class="section-header">üåÄ Sorcerer Spell Weaving</h3>
          <p class="weaving-intro">Sorcerers may weave additional effects into their spells at the cost of extra Magic Points, casting time, and increased Arcane Sorcery difficulty.</p>
          <table class="weaving-table">
            <thead>
              <tr>
                <th>Weaving Effect</th>
                <th>Additional Casting Time*</th>
                <th>Arcane Sorcery Difficulty**</th>
                <th>Extra MP Cost</th>
              </tr>
            </thead>
            <tbody>
              <tr><td><strong>Amplify</strong> <span class="weaving-desc">(Increase damage/effect by half of rolled damage)</span></td><td>+1 to Cast Time</td><td>Formidable</td><td>+3</td></tr>
              <tr><td><strong>Lingering</strong> <span class="weaving-desc">(Double duration)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+1</td></tr>
              <tr><td><strong>Wordless</strong> <span class="weaving-desc">(No verbal components)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+1</td></tr>
              <tr><td><strong>Stillness</strong> <span class="weaving-desc">(No somatic components)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+1</td></tr>
              <tr><td><strong>Quickening</strong> <span class="weaving-desc">(Cast as 1 Action)</span></td><td>‚Äî</td><td>Herculean</td><td>+4</td></tr>
              <tr><td><strong>Expanding</strong> <span class="weaving-desc">(Doubles the area of effect)</span></td><td>+1 to Cast Time</td><td>Hard</td><td>+2</td></tr>
            </tbody>
          </table>
          <div class="weaving-footnotes">
            <p class="weaving-footnote">* Added to the spell's existing Cast Time. For example, a spell with Cast Time 2 Actions becomes 3 Actions; 10 minutes becomes 11 minutes. For spells with multiple Cast Times (such as Fly: 10 minutes/Intensity +1d6√ó10 minutes), roll first then add one. Combining two weaves (e.g. Wordless + Stillness) adds +2, so Cast Time 2 Actions becomes 4 Actions.</p>
            <p class="weaving-footnote">** The Difficulty Grade Penalty affects the range of the Arcane Sorcery roll. For example, Tormos is tied up and unable to use his hands. He has Arcane Sorcery at 54% and wants to use Stillness. His difficulty grade becomes Hard, so his Arcane Sorcery skill becomes 34% for the purposes of a possible Arcane Flux. Should he fail his roll at 54 or higher (the minor Arcane Flux range ‚Äî 20% above), he may need to roll on the appropriate Arcane Flux effects table.</p>
          </div>
        </section>

      </div>
    </section>

    <!-- ==================== PAGE 6: SUMMARY ==================== -->
    <section id="page-summary" class="sheet-page page-summary">
      <div class="page-content ornate-border">
        <h2 class="page-title">Character Summary</h2>
        <p class="summary-instructions">Drag widgets from the palette to customize your quick-reference panel. Your layout is saved automatically.</p>
        
        <div class="summary-container">
          <!-- Widget Palette -->
          <div class="widget-palette">
            <h3>Available Widgets</h3>
            <div class="palette-widgets" id="palette-widgets">
              <!-- Widgets will be populated by JS -->
            </div>
          </div>
          
          <!-- Summary Canvas -->
          <div class="summary-canvas">
            <div class="canvas-grid" id="summary-canvas">
              <!-- Dropped widgets appear here -->
            </div>
            <button class="btn btn-secondary" id="btn-reset-summary">Reset Layout</button>
          </div>
        </div>
      </div>
    </section>

    <!-- ==================== PAGE 7: NOTES ==================== -->
    <section id="page-notes" class="sheet-page page-notes">
      <div class="page-content ornate-border notes-page-content">
        <h2 class="page-title">Notes</h2>
        
        <!-- Notes Layout Controls -->
        <div class="notes-layout-controls">
          <div class="notes-palette" id="notes-palette">
            <span class="palette-label">Available Sections:</span>
            <div class="palette-items" id="notes-palette-items">
              <!-- Removed sections appear here -->
            </div>
          </div>
          <div class="notes-layout-buttons">
            <button type="button" class="btn btn-small" id="btn-add-custom-section" title="Add custom section">+ Custom Section</button>
            <button type="button" class="btn btn-small btn-secondary" id="btn-reset-notes-layout" title="Reset to default layout">Reset Layout</button>
          </div>
        </div>
        
        <!-- Rich Text Toolbar -->
        <div class="notes-toolbar" id="notes-toolbar">
          <div class="toolbar-group">
            <button type="button" class="toolbar-btn" data-command="bold" title="Bold (Ctrl+B)"><strong>B</strong></button>
            <button type="button" class="toolbar-btn" data-command="italic" title="Italic (Ctrl+I)"><em>I</em></button>
            <button type="button" class="toolbar-btn" data-command="underline" title="Underline (Ctrl+U)"><u>U</u></button>
            <button type="button" class="toolbar-btn" data-command="strikeThrough" title="Strikethrough"><s>S</s></button>
          </div>
          <div class="toolbar-separator"></div>
          <div class="toolbar-group">
            <select class="toolbar-select" id="toolbar-font-family" title="Font Family">
              <option value="inherit">Default</option>
              <option value="'Cinzel', serif">Cinzel</option>
              <option value="'Times New Roman', serif">Times New Roman</option>
              <option value="'Georgia', serif">Georgia</option>
              <option value="'Arial', sans-serif">Arial</option>
              <option value="'Courier New', monospace">Courier New</option>
            </select>
            <select class="toolbar-select" id="toolbar-font-size" title="Font Size">
              <option value="0.8rem">Small</option>
              <option value="1rem" selected>Normal</option>
              <option value="1.2rem">Large</option>
              <option value="1.5rem">X-Large</option>
            </select>
          </div>
          <div class="toolbar-separator"></div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-btn" data-command="insertUnorderedList" title="Bullet List">‚Ä¢</button>
            <button type="button" class="toolbar-btn" data-command="insertOrderedList" title="Numbered List">1.</button>
          </div>
          <div class="toolbar-separator"></div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-btn" data-command="formatBlock" data-value="h3" title="Heading">H</button>
            <button type="button" class="toolbar-btn" data-command="insertHorizontalRule" title="Horizontal Line">‚îÄ</button>
          </div>
          <div class="toolbar-separator"></div>
          <div class="toolbar-group">
            <input type="color" class="toolbar-color" id="toolbar-text-color" value="#000000" title="Text Color">
            <input type="color" class="toolbar-color" id="toolbar-bg-color" value="#ffff00" title="Highlight Color">
            <button type="button" class="toolbar-btn" data-command="hiliteColor" title="Apply Highlight">üñç</button>
          </div>
          <div class="toolbar-separator"></div>
          <div class="toolbar-group">
            <button type="button" class="toolbar-btn" data-command="removeFormat" title="Clear Formatting">‚úï</button>
          </div>
        </div>
        
        <div class="notes-grid" id="notes-grid">
          <!-- Sections are dynamically rendered -->
        </div>
      </div>
    </section>

  </div>

  <!-- Scripts -->
  <script src="js/data/skill-definitions.js"></script>
  <script src="js/skill-info-data.js"></script>
  <script src="js/calculations.js"></script>
  <script src="js/storage.js"></script>
  <script src="js/weapons-data.js"></script>
  <script src="js/encumbrance-data.js"></script>
  <script src="js/class-ranks-data.js"></script>
  <script src="js/spell-data.js"></script>
  <script src="js/spell-details-data.js"></script>
  <script src="js/class-spells-data.js"></script>
  <script src="js/sorcerer-spell-tables.js"></script>
  <script src="js/arcane-flux-data.js"></script>
  <script src="js/spell-damage-data.js"></script>
  <script src="js/abilities-data.js"></script>
  <script src="js/species-data.js"></script>
  <script src="js/armor-data.js"></script>
  <script src="js/class-abilities-data.js"></script>
  <script src="js/ranked-abilities-data.js"></script>
  <script src="js/app.js"></script>
  <script>
    // Logout handler
    document.getElementById('btn-logout').addEventListener('click', function() {
      if (confirm('Are you sure you want to logout?')) {
        localStorage.removeItem('mythras_auth');
        window.location.href = 'index.html';
      }
    });
    
    // Theme toggle handler
    (function() {
      const themeBtn = document.getElementById('btn-theme');
      const app = document.getElementById('app');
      
      // Load saved theme
      const savedTheme = localStorage.getItem('mythras-theme') || 'light';
      if (savedTheme === 'dark') {
        app.dataset.theme = 'dark';
        themeBtn.textContent = '‚òÄÔ∏è';
        themeBtn.title = 'Switch to Light Mode';
      }
      
      themeBtn.addEventListener('click', function() {
        const isDark = app.dataset.theme === 'dark';
        if (isDark) {
          app.dataset.theme = '';
          themeBtn.textContent = 'üåô';
          themeBtn.title = 'Switch to Dark Mode';
          localStorage.setItem('mythras-theme', 'light');
        } else {
          app.dataset.theme = 'dark';
          themeBtn.textContent = '‚òÄÔ∏è';
          themeBtn.title = 'Switch to Light Mode';
          localStorage.setItem('mythras-theme', 'dark');
        }
      });
    })();
    
    // Class Theme toggle handler
    (function() {
      const classThemeBtn = document.getElementById('btn-class-theme');
      const body = document.body;
      
      // Function to get primary class
      function getPrimaryClass() {
        const classSelect = document.getElementById('class-primary');
        if (classSelect && classSelect.value) {
          return classSelect.value.toLowerCase().trim();
        }
        return null;
      }
      
      // Function to apply class theme
      function applyClassTheme() {
        const primaryClass = getPrimaryClass();
        if (primaryClass) {
          body.setAttribute('data-class-theme', primaryClass);
          classThemeBtn.classList.add('active');
          classThemeBtn.innerHTML = 'üé≠ ' + primaryClass.charAt(0).toUpperCase() + primaryClass.slice(1);
          localStorage.setItem('mythras-class-theme-enabled', 'true');
        }
      }
      
      // Function to remove class theme
      function removeClassTheme() {
        body.removeAttribute('data-class-theme');
        classThemeBtn.classList.remove('active');
        classThemeBtn.innerHTML = 'üé≠ Class Theme';
        localStorage.setItem('mythras-class-theme-enabled', 'false');
      }
      
      // Function to update class theme if enabled
      function updateClassThemeIfEnabled() {
        const isEnabled = localStorage.getItem('mythras-class-theme-enabled') === 'true';
        if (isEnabled) {
          applyClassTheme();
        }
      }
      
      // Load saved preference
      const savedPref = localStorage.getItem('mythras-class-theme-enabled');
      if (savedPref === 'true') {
        // Wait for character data to load, then apply
        setTimeout(function() {
          applyClassTheme();
        }, 500);
      }
      
      // Toggle button click handler
      classThemeBtn.addEventListener('click', function() {
        const isActive = classThemeBtn.classList.contains('active');
        if (isActive) {
          removeClassTheme();
        } else {
          const primaryClass = getPrimaryClass();
          if (primaryClass) {
            applyClassTheme();
          } else {
            alert('Please select a primary class first.');
          }
        }
      });
      
      // Listen for class changes to update theme
      const classSelect = document.getElementById('class-primary');
      if (classSelect) {
        classSelect.addEventListener('change', function() {
          if (classThemeBtn.classList.contains('active')) {
            applyClassTheme();
          }
        });
      }
      
      // Expose function to update theme after character load
      window.updateClassThemeAfterLoad = updateClassThemeIfEnabled;
    })();
  </script>
  
  <!-- Short Rest Modal -->
  <div class="short-rest-modal-overlay" id="short-rest-modal-overlay">
    <div class="short-rest-modal">
      <div class="short-rest-modal-header">
        <h3>‚òÄ Short Rest (15 minutes)</h3>
        <button class="short-rest-modal-close" id="short-rest-modal-close">&times;</button>
      </div>
      <div class="short-rest-modal-body">
        <p class="short-rest-intro">Choose one 15-minute Rest Action to perform:</p>
        
        <div class="short-rest-options">
          <label class="short-rest-option">
            <input type="radio" name="short-rest-action" value="eat-ration">
            <div class="short-rest-option-content">
              <span class="short-rest-option-title">üçñ Eat a Ration</span>
              <span class="short-rest-option-desc">Removes one level of Fatigue (if no greater than Exhausted) and quells hunger. If your Fatigue is then no greater than Winded, remove an additional level due to this being a non-strenuous activity. <em>(Once per day)</em></span>
            </div>
          </label>
          
          <label class="short-rest-option">
            <input type="radio" name="short-rest-action" value="pray-study">
            <div class="short-rest-option-content">
              <span class="short-rest-option-title">üìñ Pray to Deity / Study Spellbook</span>
              <span class="short-rest-option-desc">Regain 1 Magic Point. If your Fatigue is no greater than Winded, remove one level due to this being a non-strenuous activity.</span>
            </div>
          </label>
          
          <label class="short-rest-option">
            <input type="radio" name="short-rest-action" value="tend-wounds">
            <div class="short-rest-option-content">
              <span class="short-rest-option-title">ü©π Tend to Wounds</span>
              <span class="short-rest-option-desc">Use the First Aid skill (one 15-minute action) or the Healing skill (four 15-minute actions, or one hour). <em>Does not remove Fatigue.</em></span>
            </div>
          </label>
          
          <label class="short-rest-option">
            <input type="radio" name="short-rest-action" value="cast-spells">
            <div class="short-rest-option-content">
              <span class="short-rest-option-title">‚ú® Cast Spells</span>
              <span class="short-rest-option-desc">Cast any number of spells to heal or buff party members, limited by available Magic Points. <em>Does not remove Fatigue.</em></span>
            </div>
          </label>
          
          <label class="short-rest-option">
            <input type="radio" name="short-rest-action" value="prepare-spell">
            <div class="short-rest-option-content">
              <span class="short-rest-option-title">üìú Prepare a New Spell</span>
              <span class="short-rest-option-desc">Following at least 8 hours of sleep, memorize or forget an Arcane or Divine spell. <em>Does not remove Fatigue.</em></span>
            </div>
          </label>
          
          <label class="short-rest-option">
            <input type="radio" name="short-rest-action" value="dither">
            <div class="short-rest-option-content">
              <span class="short-rest-option-title">üí§ Dither</span>
              <span class="short-rest-option-desc">Waste 15 minutes doing nothing useful while waiting for others. If your Fatigue is no greater than Winded, remove one level due to this being a non-strenuous activity.</span>
            </div>
          </label>

          <hr class="short-rest-divider" id="second-wind-divider" style="display:none;">
          
          <label class="short-rest-option" id="second-wind-option" style="display:none;">
            <input type="radio" name="short-rest-action" value="second-wind">
            <div class="short-rest-option-content">
              <span class="short-rest-option-title">üí® Second Wind</span>
              <span class="short-rest-option-desc">Take a 1 hour short rest and recover up to 3 levels of lost Fatigue. <em>(Once per day)</em></span>
            </div>
          </label>
        </div>
        
        <div class="short-rest-result" id="short-rest-result"></div>
      </div>
      <div class="short-rest-modal-footer">
        <button class="btn btn-primary" id="btn-apply-short-rest">Take Rest Action</button>
        <button class="btn btn-secondary" id="btn-cancel-short-rest">Cancel</button>
      </div>
    </div>
  </div>
</body>
</html>
